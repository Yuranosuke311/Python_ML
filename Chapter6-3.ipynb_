{"cells":[{"cell_type":"code","execution_count":1,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":6743,"status":"ok","timestamp":1730347274903,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"},"user_tz":-540},"id":"xIbbKofdlUrk","outputId":"3c687eb3-0a56-497c-e226-d516c30bcc62"},"outputs":[{"output_type":"stream","name":"stdout","text":["Collecting streamlit\n","  Downloading streamlit-1.39.0-py2.py3-none-any.whl.metadata (8.5 kB)\n","Requirement already satisfied: altair<6,>=4.0 in /usr/local/lib/python3.10/dist-packages (from streamlit) (4.2.2)\n","Requirement already satisfied: blinker<2,>=1.0.0 in /usr/lib/python3/dist-packages (from streamlit) (1.4)\n","Requirement already satisfied: cachetools<6,>=4.0 in /usr/local/lib/python3.10/dist-packages (from streamlit) (5.5.0)\n","Requirement already satisfied: click<9,>=7.0 in /usr/local/lib/python3.10/dist-packages (from streamlit) (8.1.7)\n","Requirement already satisfied: numpy<3,>=1.20 in /usr/local/lib/python3.10/dist-packages (from streamlit) (1.26.4)\n","Requirement already satisfied: packaging<25,>=20 in /usr/local/lib/python3.10/dist-packages (from streamlit) (24.1)\n","Requirement already satisfied: pandas<3,>=1.4.0 in /usr/local/lib/python3.10/dist-packages (from streamlit) (2.2.2)\n","Requirement already satisfied: pillow<11,>=7.1.0 in /usr/local/lib/python3.10/dist-packages (from streamlit) (10.4.0)\n","Requirement already satisfied: protobuf<6,>=3.20 in /usr/local/lib/python3.10/dist-packages (from streamlit) (3.20.3)\n","Requirement already satisfied: pyarrow>=7.0 in /usr/local/lib/python3.10/dist-packages (from streamlit) (16.1.0)\n","Requirement already satisfied: requests<3,>=2.27 in /usr/local/lib/python3.10/dist-packages (from streamlit) (2.32.3)\n","Requirement already satisfied: rich<14,>=10.14.0 in /usr/local/lib/python3.10/dist-packages (from streamlit) (13.9.3)\n","Requirement already satisfied: tenacity<10,>=8.1.0 in /usr/local/lib/python3.10/dist-packages (from streamlit) (9.0.0)\n","Requirement already satisfied: toml<2,>=0.10.1 in /usr/local/lib/python3.10/dist-packages (from streamlit) (0.10.2)\n","Requirement already satisfied: typing-extensions<5,>=4.3.0 in /usr/local/lib/python3.10/dist-packages (from streamlit) (4.12.2)\n","Requirement already satisfied: gitpython!=3.1.19,<4,>=3.0.7 in /usr/local/lib/python3.10/dist-packages (from streamlit) (3.1.43)\n","Collecting pydeck<1,>=0.8.0b4 (from streamlit)\n","  Downloading pydeck-0.9.1-py2.py3-none-any.whl.metadata (4.1 kB)\n","Requirement already satisfied: tornado<7,>=6.0.3 in /usr/local/lib/python3.10/dist-packages (from streamlit) (6.3.3)\n","Collecting watchdog<6,>=2.1.5 (from streamlit)\n","  Downloading watchdog-5.0.3-py3-none-manylinux2014_x86_64.whl.metadata (41 kB)\n","\u001b[2K     \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m41.9/41.9 kB\u001b[0m \u001b[31m3.1 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hRequirement already satisfied: entrypoints in /usr/local/lib/python3.10/dist-packages (from altair<6,>=4.0->streamlit) (0.4)\n","Requirement already satisfied: jinja2 in /usr/local/lib/python3.10/dist-packages (from altair<6,>=4.0->streamlit) (3.1.4)\n","Requirement already satisfied: jsonschema>=3.0 in /usr/local/lib/python3.10/dist-packages (from altair<6,>=4.0->streamlit) (4.23.0)\n","Requirement already satisfied: toolz in /usr/local/lib/python3.10/dist-packages (from altair<6,>=4.0->streamlit) (0.12.1)\n","Requirement already satisfied: gitdb<5,>=4.0.1 in /usr/local/lib/python3.10/dist-packages (from gitpython!=3.1.19,<4,>=3.0.7->streamlit) (4.0.11)\n","Requirement already satisfied: python-dateutil>=2.8.2 in /usr/local/lib/python3.10/dist-packages (from pandas<3,>=1.4.0->streamlit) (2.8.2)\n","Requirement already satisfied: pytz>=2020.1 in /usr/local/lib/python3.10/dist-packages (from pandas<3,>=1.4.0->streamlit) (2024.2)\n","Requirement already satisfied: tzdata>=2022.7 in /usr/local/lib/python3.10/dist-packages (from pandas<3,>=1.4.0->streamlit) (2024.2)\n","Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests<3,>=2.27->streamlit) (3.4.0)\n","Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests<3,>=2.27->streamlit) (3.10)\n","Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests<3,>=2.27->streamlit) (2.2.3)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests<3,>=2.27->streamlit) (2024.8.30)\n","Requirement already satisfied: markdown-it-py>=2.2.0 in /usr/local/lib/python3.10/dist-packages (from rich<14,>=10.14.0->streamlit) (3.0.0)\n","Requirement already satisfied: pygments<3.0.0,>=2.13.0 in /usr/local/lib/python3.10/dist-packages (from rich<14,>=10.14.0->streamlit) (2.18.0)\n","Requirement already satisfied: smmap<6,>=3.0.1 in /usr/local/lib/python3.10/dist-packages (from gitdb<5,>=4.0.1->gitpython!=3.1.19,<4,>=3.0.7->streamlit) (5.0.1)\n","Requirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2->altair<6,>=4.0->streamlit) (3.0.2)\n","Requirement already satisfied: attrs>=22.2.0 in /usr/local/lib/python3.10/dist-packages (from jsonschema>=3.0->altair<6,>=4.0->streamlit) (24.2.0)\n","Requirement already satisfied: jsonschema-specifications>=2023.03.6 in /usr/local/lib/python3.10/dist-packages (from jsonschema>=3.0->altair<6,>=4.0->streamlit) (2024.10.1)\n","Requirement already satisfied: referencing>=0.28.4 in /usr/local/lib/python3.10/dist-packages (from jsonschema>=3.0->altair<6,>=4.0->streamlit) (0.35.1)\n","Requirement already satisfied: rpds-py>=0.7.1 in /usr/local/lib/python3.10/dist-packages (from jsonschema>=3.0->altair<6,>=4.0->streamlit) (0.20.0)\n","Requirement already satisfied: mdurl~=0.1 in /usr/local/lib/python3.10/dist-packages (from markdown-it-py>=2.2.0->rich<14,>=10.14.0->streamlit) (0.1.2)\n","Requirement already satisfied: six>=1.5 in /usr/local/lib/python3.10/dist-packages (from python-dateutil>=2.8.2->pandas<3,>=1.4.0->streamlit) (1.16.0)\n","Downloading streamlit-1.39.0-py2.py3-none-any.whl (8.7 MB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m8.7/8.7 MB\u001b[0m \u001b[31m60.5 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hDownloading pydeck-0.9.1-py2.py3-none-any.whl (6.9 MB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m6.9/6.9 MB\u001b[0m \u001b[31m85.7 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hDownloading watchdog-5.0.3-py3-none-manylinux2014_x86_64.whl (79 kB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m79.3/79.3 kB\u001b[0m \u001b[31m7.4 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hInstalling collected packages: watchdog, pydeck, streamlit\n","Successfully installed pydeck-0.9.1 streamlit-1.39.0 watchdog-5.0.3\n","Requirement already satisfied: openai in /usr/local/lib/python3.10/dist-packages (1.52.2)\n","Requirement already satisfied: anyio<5,>=3.5.0 in /usr/local/lib/python3.10/dist-packages (from openai) (3.7.1)\n","Requirement already satisfied: distro<2,>=1.7.0 in /usr/local/lib/python3.10/dist-packages (from openai) (1.9.0)\n","Requirement already satisfied: httpx<1,>=0.23.0 in /usr/local/lib/python3.10/dist-packages (from openai) (0.27.2)\n","Requirement already satisfied: jiter<1,>=0.4.0 in /usr/local/lib/python3.10/dist-packages (from openai) (0.6.1)\n","Requirement already satisfied: pydantic<3,>=1.9.0 in /usr/local/lib/python3.10/dist-packages (from openai) (2.9.2)\n","Requirement already satisfied: sniffio in /usr/local/lib/python3.10/dist-packages (from openai) (1.3.1)\n","Requirement already satisfied: tqdm>4 in /usr/local/lib/python3.10/dist-packages (from openai) (4.66.5)\n","Requirement already satisfied: typing-extensions<5,>=4.11 in /usr/local/lib/python3.10/dist-packages (from openai) (4.12.2)\n","Requirement already satisfied: idna>=2.8 in /usr/local/lib/python3.10/dist-packages (from anyio<5,>=3.5.0->openai) (3.10)\n","Requirement already satisfied: exceptiongroup in /usr/local/lib/python3.10/dist-packages (from anyio<5,>=3.5.0->openai) (1.2.2)\n","Requirement already satisfied: certifi in /usr/local/lib/python3.10/dist-packages (from httpx<1,>=0.23.0->openai) (2024.8.30)\n","Requirement already satisfied: httpcore==1.* in /usr/local/lib/python3.10/dist-packages (from httpx<1,>=0.23.0->openai) (1.0.6)\n","Requirement already satisfied: h11<0.15,>=0.13 in /usr/local/lib/python3.10/dist-packages (from httpcore==1.*->httpx<1,>=0.23.0->openai) (0.14.0)\n","Requirement already satisfied: annotated-types>=0.6.0 in /usr/local/lib/python3.10/dist-packages (from pydantic<3,>=1.9.0->openai) (0.7.0)\n","Requirement already satisfied: pydantic-core==2.23.4 in /usr/local/lib/python3.10/dist-packages (from pydantic<3,>=1.9.0->openai) (2.23.4)\n"]}],"source":["!pip install streamlit\n","!pip install openai"]},{"cell_type":"code","execution_count":2,"metadata":{"executionInfo":{"elapsed":2901,"status":"ok","timestamp":1730347280077,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"},"user_tz":-540},"id":"ub48UbQ-KHWB","colab":{"base_uri":"https://localhost:8080/"},"outputId":"305699d3-a97a-49cd-be71-bea2d0f19dc7"},"outputs":[{"output_type":"stream","name":"stdout","text":["\u001b[?25l   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m0.0/50.4 kB\u001b[0m \u001b[31m?\u001b[0m eta \u001b[36m-:--:--\u001b[0m\r\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m50.4/50.4 kB\u001b[0m \u001b[31m4.1 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25h\u001b[?25l   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m0.0/1.2 MB\u001b[0m \u001b[31m?\u001b[0m eta \u001b[36m-:--:--\u001b[0m\r\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m1.2/1.2 MB\u001b[0m \u001b[31m51.1 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25h"]}],"source":["!pip install -qU langchain-openai"]},{"cell_type":"code","execution_count":3,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":3053,"status":"ok","timestamp":1730347286592,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"},"user_tz":-540},"id":"i6asQr0VX78z","outputId":"fb77f84b-2018-41f2-bdb2-f8910f2b7a5c"},"outputs":[{"output_type":"stream","name":"stdout","text":["This is a test. How can I assist you further?"]}],"source":["from openai import OpenAI\n","\n","import os\n","os.environ[\"OPENAI_API_KEY\"] = \"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\"\n","\n","client = OpenAI()\n","\n","stream = client.chat.completions.create(\n","    model=\"gpt-4o-mini\",\n","    messages=[{\"role\": \"user\", \"content\": \"Say this is a test\"}],\n","    stream=True,\n",")\n","for chunk in stream:\n","    if chunk.choices[0].delta.content is not None:\n","        print(chunk.choices[0].delta.content, end=\"\")"]},{"cell_type":"code","execution_count":4,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":28479,"status":"ok","timestamp":1730347317380,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"},"user_tz":-540},"id":"HEcEs3rJlVyb","outputId":"263ca5de-cd0d-4068-c7e1-d044f318c6f6"},"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/drive\n"]}],"source":["# Google Driveと接続を行います。これを行うことで、Driveにあるデータにアクセスできるようになります。\n","# 下記セルを実行すると、Googleアカウントのログインを求められますのでログインしてください。\n","from google.colab import drive\n","drive.mount('/content/drive')\n","\n","# 作業フォルダへの移動を行います。\n","# もしアップロードした場所が異なる場合は作業場所を変更してください。\n","import os\n","os.chdir('/content/drive/MyDrive/プログラミング（AI活用）') #ここを変更"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":17},"executionInfo":{"elapsed":8,"status":"ok","timestamp":1729741948732,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"},"user_tz":-540},"id":"4-en5D_Xligf","outputId":"e914f01d-f137-422a-ed21-74cfd4e27204"},"outputs":[{"output_type":"display_data","data":{"text/plain":["<IPython.core.display.Javascript object>"],"application/javascript":["\n","      ((filepath) => {{\n","        if (!google.colab.kernel.accessAllowed) {{\n","          return;\n","        }}\n","        google.colab.files.view(filepath);\n","      }})(\"/content/drive/MyDrive/\\u30d5\\u309a\\u30ed\\u30af\\u3099\\u30e9\\u30df\\u30f3\\u30af\\u3099\\uff08AI\\u6d3b\\u7528\\uff09/AI_program.py\")"]},"metadata":{}}],"source":["# ファイルの表示\n","from google.colab import files\n","files.view(\"AI_program.py\")"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"6StErHWhmFs4","executionInfo":{"status":"ok","timestamp":1729741956767,"user_tz":-540,"elapsed":8041,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"197aafbc-2630-4c9d-fc95-f9d8640a21b8"},"outputs":[{"output_type":"stream","name":"stdout","text":["\n","Collecting usage statistics. To deactivate, set browser.gatherUsageStats to false.\n","\u001b[0m\n","\u001b[0m\n","\u001b[34m\u001b[1m  You can now view your Streamlit app in your browser.\u001b[0m\n","\u001b[0m\n","\u001b[34m  Local URL: \u001b[0m\u001b[1mhttp://localhost:8501\u001b[0m\n","\u001b[34m  Network URL: \u001b[0m\u001b[1mhttp://172.28.0.12:8501\u001b[0m\n","\u001b[34m  External URL: \u001b[0m\u001b[1mhttp://34.91.197.38:8501\u001b[0m\n","\u001b[0m\n","\u001b[34m  Stopping...\u001b[0m\n","\u001b[K\u001b[?25h^C\n"]}],"source":["# Streamlitを動かす処理\n","!streamlit run AI_program.py & sleep 3 && npx --yes localtunnel --port 8501"]},{"cell_type":"markdown","source":["基本的なAI（翻訳、天気）"],"metadata":{"id":"w9z8yrh__My8"}},{"cell_type":"code","source":["import os\n","import openai\n","import getpass\n","\n","if not os.environ.get(\"OPENAI_API_KEY\"):\n","    os.environ[\"OPENAI_API_KEY\"] = getpass.getpass(\"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 \")\n","\n","\n","#input\n","\n","#process\n","#process\n","from langchain_openai import ChatOpenAI\n","\n","llm = ChatOpenAI(\n","    model=\"gpt-4o\",\n","    temperature=0,\n","    max_tokens=None,\n","    timeout=None,\n","    max_retries=2,\n",")\n","messages = [\n","    (\n","        \"system\",\n","        \"You are a helpful assistant that translates English to Chinese. Translate the user sentence.\",\n","    ),\n","    (\"human\", \"I love programming.\"),\n","]\n","ai_msg = llm.invoke(messages)\n","ai_msg"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"dlLdOG28VsxA","executionInfo":{"status":"ok","timestamp":1729741960828,"user_tz":-540,"elapsed":4065,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"d9e91731-eba9-4ad5-efb3-9819cdca4b64"},"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/plain":["AIMessage(content='我热爱编程。', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 6, 'prompt_tokens': 31, 'total_tokens': 37, 'completion_tokens_details': {'audio_tokens': None, 'reasoning_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-2024-08-06', 'system_fingerprint': 'fp_a7d06e42a7', 'finish_reason': 'stop', 'logprobs': None}, id='run-807d5de5-5879-4387-a500-ed488fb17adf-0', usage_metadata={'input_tokens': 31, 'output_tokens': 6, 'total_tokens': 37, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 0}})"]},"metadata":{},"execution_count":14}]},{"cell_type":"code","source":["print(ai_msg.content)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"IhSquuakV55a","executionInfo":{"status":"ok","timestamp":1729741960828,"user_tz":-540,"elapsed":11,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"3623f65f-cfdf-449e-cee9-86b68efa69ad"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["我热爱编程。\n"]}]},{"cell_type":"code","source":["from langchain_core.prompts import ChatPromptTemplate\n","\n","prompt = ChatPromptTemplate.from_messages(\n","    [\n","        (\n","            \"system\",\n","            \"You are a helpful assistant that translates {input_language} to {output_language}.\",\n","        ),\n","        (\"human\", \"{input}\"),\n","    ]\n",")\n","\n","chain = prompt | llm\n","chain.invoke(\n","    {\n","        \"input_language\": \"English\",\n","        \"output_language\": \"German\",\n","        \"input\": \"I love programming.\",\n","    }\n",")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"fvoqFs77WDfN","executionInfo":{"status":"ok","timestamp":1729741961230,"user_tz":-540,"elapsed":408,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"8e367698-8056-40e4-ca1a-ec3e6f306ca9"},"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/plain":["AIMessage(content='Ich liebe Programmieren.', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 26, 'total_tokens': 31, 'completion_tokens_details': {'audio_tokens': None, 'reasoning_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-2024-08-06', 'system_fingerprint': 'fp_90354628f2', 'finish_reason': 'stop', 'logprobs': None}, id='run-ea334710-f10d-4c96-ae3f-bfbec9a4764b-0', usage_metadata={'input_tokens': 26, 'output_tokens': 5, 'total_tokens': 31, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 0}})"]},"metadata":{},"execution_count":16}]},{"cell_type":"code","source":["from pydantic import BaseModel, Field\n","\n","\n","class GetWeather(BaseModel):\n","    \"\"\"Get the current weather in a given location\"\"\"\n","\n","    location: str = Field(..., description=\"The city and state, e.g. San Francisco, CA\")\n","\n","\n","llm_with_tools = llm.bind_tools([GetWeather])"],"metadata":{"id":"8aijnhHCWTwA"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["llm_with_tools = llm.bind_tools([GetWeather], strict=True)\n","ai_msg = llm_with_tools.invoke(\n","    \"what is the weather like in San Francisco\",\n",")\n","ai_msg"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"2UdequFgWPUg","executionInfo":{"status":"ok","timestamp":1729741962206,"user_tz":-540,"elapsed":561,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"59b02fdc-ce36-45d0-c1c6-2f8de411af15"},"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/plain":["AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_lSUr6Hvo8Dw3dwWgCSxISjhJ', 'function': {'arguments': '{\"location\":\"San Francisco, CA\"}', 'name': 'GetWeather'}, 'type': 'function'}], 'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 17, 'prompt_tokens': 68, 'total_tokens': 85, 'completion_tokens_details': {'audio_tokens': None, 'reasoning_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-2024-08-06', 'system_fingerprint': 'fp_90354628f2', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-18bd4fde-26a4-49e4-85d1-b7de41bdb125-0', tool_calls=[{'name': 'GetWeather', 'args': {'location': 'San Francisco, CA'}, 'id': 'call_lSUr6Hvo8Dw3dwWgCSxISjhJ', 'type': 'tool_call'}], usage_metadata={'input_tokens': 68, 'output_tokens': 17, 'total_tokens': 85, 'input_token_details': {'cache_read': 0}, 'output_token_details': {'reasoning': 0}})"]},"metadata":{},"execution_count":18}]},{"cell_type":"code","source":["print(ai_msg.content)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"oHvgFnRYWYYa","executionInfo":{"status":"ok","timestamp":1729741962207,"user_tz":-540,"elapsed":14,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"1997883a-3465-4b55-d143-671abcb937b8"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["\n"]}]},{"cell_type":"code","source":["ai_msg.tool_calls"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"5PNFxpC-WmO_","executionInfo":{"status":"ok","timestamp":1729741962207,"user_tz":-540,"elapsed":10,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"d4a463fc-cb7c-46ab-a336-4c1e2c43add0"},"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/plain":["[{'name': 'GetWeather',\n","  'args': {'location': 'San Francisco, CA'},\n","  'id': 'call_lSUr6Hvo8Dw3dwWgCSxISjhJ',\n","  'type': 'tool_call'}]"]},"metadata":{},"execution_count":20}]},{"cell_type":"markdown","source":["Langchain"],"metadata":{"id":"Lgu1DpPo_d0C"}},{"cell_type":"code","source":["from langchain_openai import ChatOpenAI"],"metadata":{"id":"CVFDatCXW2mB"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["!pip install langchain langchain-community langchain-openai python-dotenv"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"j4L4qQOCXB6K","executionInfo":{"status":"ok","timestamp":1730347342569,"user_tz":-540,"elapsed":9037,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"177f3f9f-a262-4e65-a2fa-8b06e4c69ae3"},"execution_count":5,"outputs":[{"output_type":"stream","name":"stdout","text":["Requirement already satisfied: langchain in /usr/local/lib/python3.10/dist-packages (0.3.4)\n","Collecting langchain-community\n","  Downloading langchain_community-0.3.4-py3-none-any.whl.metadata (2.9 kB)\n","Requirement already satisfied: langchain-openai in /usr/local/lib/python3.10/dist-packages (0.2.4)\n","Collecting python-dotenv\n","  Downloading python_dotenv-1.0.1-py3-none-any.whl.metadata (23 kB)\n","Requirement already satisfied: PyYAML>=5.3 in /usr/local/lib/python3.10/dist-packages (from langchain) (6.0.2)\n","Requirement already satisfied: SQLAlchemy<3,>=1.4 in /usr/local/lib/python3.10/dist-packages (from langchain) (2.0.36)\n","Requirement already satisfied: aiohttp<4.0.0,>=3.8.3 in /usr/local/lib/python3.10/dist-packages (from langchain) (3.10.10)\n","Requirement already satisfied: async-timeout<5.0.0,>=4.0.0 in /usr/local/lib/python3.10/dist-packages (from langchain) (4.0.3)\n","Requirement already satisfied: langchain-core<0.4.0,>=0.3.12 in /usr/local/lib/python3.10/dist-packages (from langchain) (0.3.13)\n","Requirement already satisfied: langchain-text-splitters<0.4.0,>=0.3.0 in /usr/local/lib/python3.10/dist-packages (from langchain) (0.3.0)\n","Requirement already satisfied: langsmith<0.2.0,>=0.1.17 in /usr/local/lib/python3.10/dist-packages (from langchain) (0.1.137)\n","Requirement already satisfied: numpy<2,>=1 in /usr/local/lib/python3.10/dist-packages (from langchain) (1.26.4)\n","Requirement already satisfied: pydantic<3.0.0,>=2.7.4 in /usr/local/lib/python3.10/dist-packages (from langchain) (2.9.2)\n","Requirement already satisfied: requests<3,>=2 in /usr/local/lib/python3.10/dist-packages (from langchain) (2.32.3)\n","Requirement already satisfied: tenacity!=8.4.0,<10,>=8.1.0 in /usr/local/lib/python3.10/dist-packages (from langchain) (9.0.0)\n","Collecting dataclasses-json<0.7,>=0.5.7 (from langchain-community)\n","  Downloading dataclasses_json-0.6.7-py3-none-any.whl.metadata (25 kB)\n","Collecting httpx-sse<0.5.0,>=0.4.0 (from langchain-community)\n","  Downloading httpx_sse-0.4.0-py3-none-any.whl.metadata (9.0 kB)\n","Collecting langchain\n","  Downloading langchain-0.3.6-py3-none-any.whl.metadata (7.1 kB)\n","Collecting langchain-core<0.4.0,>=0.3.12 (from langchain)\n","  Downloading langchain_core-0.3.14-py3-none-any.whl.metadata (6.3 kB)\n","Collecting pydantic-settings<3.0.0,>=2.4.0 (from langchain-community)\n","  Downloading pydantic_settings-2.6.0-py3-none-any.whl.metadata (3.5 kB)\n","Requirement already satisfied: openai<2.0.0,>=1.52.0 in /usr/local/lib/python3.10/dist-packages (from langchain-openai) (1.52.2)\n","Requirement already satisfied: tiktoken<1,>=0.7 in /usr/local/lib/python3.10/dist-packages (from langchain-openai) (0.8.0)\n","Requirement already satisfied: aiohappyeyeballs>=2.3.0 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain) (2.4.3)\n","Requirement already satisfied: aiosignal>=1.1.2 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain) (1.3.1)\n","Requirement already satisfied: attrs>=17.3.0 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain) (24.2.0)\n","Requirement already satisfied: frozenlist>=1.1.1 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain) (1.5.0)\n","Requirement already satisfied: multidict<7.0,>=4.5 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain) (6.1.0)\n","Requirement already satisfied: yarl<2.0,>=1.12.0 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain) (1.16.0)\n","Collecting marshmallow<4.0.0,>=3.18.0 (from dataclasses-json<0.7,>=0.5.7->langchain-community)\n","  Downloading marshmallow-3.23.0-py3-none-any.whl.metadata (7.6 kB)\n","Collecting typing-inspect<1,>=0.4.0 (from dataclasses-json<0.7,>=0.5.7->langchain-community)\n","  Downloading typing_inspect-0.9.0-py3-none-any.whl.metadata (1.5 kB)\n","Requirement already satisfied: jsonpatch<2.0,>=1.33 in /usr/local/lib/python3.10/dist-packages (from langchain-core<0.4.0,>=0.3.12->langchain) (1.33)\n","Requirement already satisfied: packaging<25,>=23.2 in /usr/local/lib/python3.10/dist-packages (from langchain-core<0.4.0,>=0.3.12->langchain) (24.1)\n","Requirement already satisfied: typing-extensions>=4.7 in /usr/local/lib/python3.10/dist-packages (from langchain-core<0.4.0,>=0.3.12->langchain) (4.12.2)\n","Requirement already satisfied: httpx<1,>=0.23.0 in /usr/local/lib/python3.10/dist-packages (from langsmith<0.2.0,>=0.1.17->langchain) (0.27.2)\n","Requirement already satisfied: orjson<4.0.0,>=3.9.14 in /usr/local/lib/python3.10/dist-packages (from langsmith<0.2.0,>=0.1.17->langchain) (3.10.10)\n","Requirement already satisfied: requests-toolbelt<2.0.0,>=1.0.0 in /usr/local/lib/python3.10/dist-packages (from langsmith<0.2.0,>=0.1.17->langchain) (1.0.0)\n","Requirement already satisfied: anyio<5,>=3.5.0 in /usr/local/lib/python3.10/dist-packages (from openai<2.0.0,>=1.52.0->langchain-openai) (3.7.1)\n","Requirement already satisfied: distro<2,>=1.7.0 in /usr/local/lib/python3.10/dist-packages (from openai<2.0.0,>=1.52.0->langchain-openai) (1.9.0)\n","Requirement already satisfied: jiter<1,>=0.4.0 in /usr/local/lib/python3.10/dist-packages (from openai<2.0.0,>=1.52.0->langchain-openai) (0.6.1)\n","Requirement already satisfied: sniffio in /usr/local/lib/python3.10/dist-packages (from openai<2.0.0,>=1.52.0->langchain-openai) (1.3.1)\n","Requirement already satisfied: tqdm>4 in /usr/local/lib/python3.10/dist-packages (from openai<2.0.0,>=1.52.0->langchain-openai) (4.66.5)\n","Requirement already satisfied: annotated-types>=0.6.0 in /usr/local/lib/python3.10/dist-packages (from pydantic<3.0.0,>=2.7.4->langchain) (0.7.0)\n","Requirement already satisfied: pydantic-core==2.23.4 in /usr/local/lib/python3.10/dist-packages (from pydantic<3.0.0,>=2.7.4->langchain) (2.23.4)\n","Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests<3,>=2->langchain) (3.4.0)\n","Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests<3,>=2->langchain) (3.10)\n","Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests<3,>=2->langchain) (2.2.3)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests<3,>=2->langchain) (2024.8.30)\n","Requirement already satisfied: greenlet!=0.4.17 in /usr/local/lib/python3.10/dist-packages (from SQLAlchemy<3,>=1.4->langchain) (3.1.1)\n","Requirement already satisfied: regex>=2022.1.18 in /usr/local/lib/python3.10/dist-packages (from tiktoken<1,>=0.7->langchain-openai) (2024.9.11)\n","Requirement already satisfied: exceptiongroup in /usr/local/lib/python3.10/dist-packages (from anyio<5,>=3.5.0->openai<2.0.0,>=1.52.0->langchain-openai) (1.2.2)\n","Requirement already satisfied: httpcore==1.* in /usr/local/lib/python3.10/dist-packages (from httpx<1,>=0.23.0->langsmith<0.2.0,>=0.1.17->langchain) (1.0.6)\n","Requirement already satisfied: h11<0.15,>=0.13 in /usr/local/lib/python3.10/dist-packages (from httpcore==1.*->httpx<1,>=0.23.0->langsmith<0.2.0,>=0.1.17->langchain) (0.14.0)\n","Requirement already satisfied: jsonpointer>=1.9 in /usr/local/lib/python3.10/dist-packages (from jsonpatch<2.0,>=1.33->langchain-core<0.4.0,>=0.3.12->langchain) (3.0.0)\n","Collecting mypy-extensions>=0.3.0 (from typing-inspect<1,>=0.4.0->dataclasses-json<0.7,>=0.5.7->langchain-community)\n","  Downloading mypy_extensions-1.0.0-py3-none-any.whl.metadata (1.1 kB)\n","Requirement already satisfied: propcache>=0.2.0 in /usr/local/lib/python3.10/dist-packages (from yarl<2.0,>=1.12.0->aiohttp<4.0.0,>=3.8.3->langchain) (0.2.0)\n","Downloading langchain_community-0.3.4-py3-none-any.whl (2.4 MB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m2.4/2.4 MB\u001b[0m \u001b[31m13.7 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hDownloading langchain-0.3.6-py3-none-any.whl (1.0 MB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m1.0/1.0 MB\u001b[0m \u001b[31m52.8 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hDownloading python_dotenv-1.0.1-py3-none-any.whl (19 kB)\n","Downloading dataclasses_json-0.6.7-py3-none-any.whl (28 kB)\n","Downloading httpx_sse-0.4.0-py3-none-any.whl (7.8 kB)\n","Downloading langchain_core-0.3.14-py3-none-any.whl (408 kB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m408.7/408.7 kB\u001b[0m \u001b[31m32.8 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hDownloading pydantic_settings-2.6.0-py3-none-any.whl (28 kB)\n","Downloading marshmallow-3.23.0-py3-none-any.whl (49 kB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m49.5/49.5 kB\u001b[0m \u001b[31m4.7 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hDownloading typing_inspect-0.9.0-py3-none-any.whl (8.8 kB)\n","Downloading mypy_extensions-1.0.0-py3-none-any.whl (4.7 kB)\n","Installing collected packages: python-dotenv, mypy-extensions, marshmallow, httpx-sse, typing-inspect, pydantic-settings, dataclasses-json, langchain-core, langchain, langchain-community\n","  Attempting uninstall: langchain-core\n","    Found existing installation: langchain-core 0.3.13\n","    Uninstalling langchain-core-0.3.13:\n","      Successfully uninstalled langchain-core-0.3.13\n","  Attempting uninstall: langchain\n","    Found existing installation: langchain 0.3.4\n","    Uninstalling langchain-0.3.4:\n","      Successfully uninstalled langchain-0.3.4\n","Successfully installed dataclasses-json-0.6.7 httpx-sse-0.4.0 langchain-0.3.6 langchain-community-0.3.4 langchain-core-0.3.14 marshmallow-3.23.0 mypy-extensions-1.0.0 pydantic-settings-2.6.0 python-dotenv-1.0.1 typing-inspect-0.9.0\n"]}]},{"cell_type":"code","source":["# LLM ラッパーをインポート\n","from langchain.llms import OpenAI\n","\n","# LLM ラッパーを初期化\n","llm = OpenAI(temperature=0.7)\n","\n","# LLM に渡す入力テキスト\n","text = \"カラフルな靴下を作る会社の社名として、何かいいものはないですか？日本語の社名でお願いします。\"\n","\n","# LLM から予測を受け取って表示\n","prediction = llm(text)\n","print(prediction.strip())"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"m2FLZACBXeNn","executionInfo":{"status":"ok","timestamp":1730351489047,"user_tz":-540,"elapsed":2442,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"90ef309e-e8b6-43b7-ce58-3c55cc83b1bf"},"execution_count":44,"outputs":[{"output_type":"stream","name":"stderr","text":["<ipython-input-44-d13fc713ce89>:11: LangChainDeprecationWarning: The method `BaseLLM.__call__` was deprecated in langchain-core 0.1.7 and will be removed in 1.0. Use :meth:`~invoke` instead.\n","  prediction = llm(text)\n"]},{"output_type":"stream","name":"stdout","text":["1. 虹色ソックス株式会社\n","2. レインボーソックス有限会社\n","3. カラフルソックス製造株式会社\n","4. マルチカラーソックス株式会社\n","5. カラーショックス株式会社\n","6. ハッピーソックス有限会社\n","7. ポップソックス製造株式会社\n","8. カラフルフットウェア株式会社\n","9. カラーフルーツソックス有限会社\n","10. ブライトソックス株式会社\n"]}]},{"cell_type":"code","source":["# `PromptTemplate` をインポート\n","from langchain.prompts import PromptTemplate\n","\n","# プロンプトテンプレートの作成\n","prompt = PromptTemplate(\n","    input_variables=[\"product\"],\n","    template=\"{product}を作る会社の社名として、何かいいものはないですか？日本語の社名でお願いします。\",\n",")\n","\n","# テンプレートからプロンプトを作成\n","prompt = prompt.format(product=\"カラフルな靴下\")\n","print(prompt)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"PXA-IZBvXjHF","executionInfo":{"status":"ok","timestamp":1730351495271,"user_tz":-540,"elapsed":564,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"0efaea24-a0b5-463b-b0de-88f5a33f31a3"},"execution_count":45,"outputs":[{"output_type":"stream","name":"stdout","text":["カラフルな靴下を作る会社の社名として、何かいいものはないですか？日本語の社名でお願いします。\n"]}]},{"cell_type":"code","source":["from langchain.llms import OpenAI\n","from langchain.prompts import PromptTemplate\n","\n","# LLM チェーンをインポート\n","from langchain.chains import LLMChain\n","\n","# LLM ラッパーを初期化\n","llm = OpenAI(temperature=0.7)\n","\n","# プロンプトテンプレートの作成\n","prompt = PromptTemplate(\n","    input_variables=[\"product\"],\n","    template=\"{product}を作る会社の社名として、何かいいものはないですか？日本語の社名でお願いします。\",\n",")\n","\n","# LLM チェーンを作成（LLM ラッパーとプロンプトテンプレートから構成する）\n","chain = LLMChain(llm=llm, prompt=prompt)\n","\n","# LLM　チェーンを実行\n","prediction = chain.run(\"カラフルな靴下\")\n","print(prediction.strip())"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"gOqVyRFfXvkf","executionInfo":{"status":"ok","timestamp":1729741979245,"user_tz":-540,"elapsed":2021,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"e8d411a4-08fa-44be-d013-5c57b27c43ef"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stderr","text":["<ipython-input-25-6428c4e8a87a>:17: LangChainDeprecationWarning: The class `LLMChain` was deprecated in LangChain 0.1.17 and will be removed in 1.0. Use :meth:`~RunnableSequence, e.g., `prompt | llm`` instead.\n","  chain = LLMChain(llm=llm, prompt=prompt)\n","<ipython-input-25-6428c4e8a87a>:20: LangChainDeprecationWarning: The method `Chain.run` was deprecated in langchain 0.1.0 and will be removed in 1.0. Use :meth:`~invoke` instead.\n","  prediction = chain.run(\"カラフルな靴下\")\n"]},{"output_type":"stream","name":"stdout","text":["1. レインボーソックス株式会社\n","2. カラフルフットウェア株式会社\n","3. ハピソックス株式会社\n","4. ポップソックス株式会社\n","5. カラーソックスジャパン株式会社\n","6. マルチカラーソックス株式会社\n","7. ハッピークローゼット株式会社\n","8. カラフルフットジョイ株式会社\n","9. プリズムソックス株式会社\n","10. カラフルステップ株式会社\n"]}]},{"cell_type":"markdown","source":["RAG実装"],"metadata":{"id":"DYyqyuZt_lC9"}},{"cell_type":"code","source":["!pip install google-search-results"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"x9tblgz8X36G","executionInfo":{"status":"ok","timestamp":1730347461499,"user_tz":-540,"elapsed":3882,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"07d6f260-5594-465c-9b5f-18ac1bcdebbf"},"execution_count":10,"outputs":[{"output_type":"stream","name":"stdout","text":["Collecting google-search-results\n","  Downloading google_search_results-2.4.2.tar.gz (18 kB)\n","  Preparing metadata (setup.py) ... \u001b[?25l\u001b[?25hdone\n","Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from google-search-results) (2.32.3)\n","Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests->google-search-results) (3.4.0)\n","Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests->google-search-results) (3.10)\n","Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests->google-search-results) (2.2.3)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests->google-search-results) (2024.8.30)\n","Building wheels for collected packages: google-search-results\n","  Building wheel for google-search-results (setup.py) ... \u001b[?25l\u001b[?25hdone\n","  Created wheel for google-search-results: filename=google_search_results-2.4.2-py3-none-any.whl size=32009 sha256=631014468c5dec01a30b2643140bb324b2e1fcc70d9496cd131197d3fcafe820\n","  Stored in directory: /root/.cache/pip/wheels/d3/b2/c3/03302d12bb44a2cdff3c9371f31b72c0c4e84b8d2285eeac53\n","Successfully built google-search-results\n","Installing collected packages: google-search-results\n","Successfully installed google-search-results-2.4.2\n"]}]},{"cell_type":"code","source":["%env SERPAPI_API_KEY=da456208e6fbb6c5792809e2e3f107af208650a88b8e2fa0920a467a5110febc"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"okcGFIqNYZoc","executionInfo":{"status":"ok","timestamp":1730347454084,"user_tz":-540,"elapsed":490,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"f3f7783b-595d-4ce7-d472-bff6d4f07204"},"execution_count":9,"outputs":[{"output_type":"stream","name":"stdout","text":["env: SERPAPI_API_KEY=da456208e6fbb6c5792809e2e3f107af208650a88b8e2fa0920a467a5110febc\n"]}]},{"cell_type":"code","source":[],"metadata":{"id":"GLncYVdyB_LY"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["from langchain.agents import load_tools\n","from langchain.agents import initialize_agent\n","from langchain.llms import OpenAI\n","\n","# LLM ラッパーを導入します。これは、エージェントをコントロールするために使われます。\n","llm = OpenAI(temperature=0)\n","\n","# ツールを導入します。 `llm-math` ツールを使うのに LLM を指定する必要があることに注意してください\n","tools = load_tools([\"serpapi\", \"llm-math\"], llm=llm)\n","\n","# エージェントを初期化します\n","# 初期化時には、使用するツールの一覧と、使用する LLM, エージェントの種類を指定します\n","# ここで指定している \"zero-shot-react-description\" というエージェントは、ツールの説明のみに基づいて、どのツールを使用するかを決定してくれます\n","agent = initialize_agent(tools, llm, agent=\"zero-shot-react-description\", verbose=True)\n","\n","#エージェントにタスクを実行してもらいます\n","agent.run(\"昨日の東京の最高気温は何度でしたか？摂氏温度でお答え下さい。また、その温度の0.23乗 は何ですか？\")"],"metadata":{"id":"jd8IrM1bYi5t","executionInfo":{"status":"ok","timestamp":1730351642382,"user_tz":-540,"elapsed":7577,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"b86d470c-c693-47d6-c0e7-b1b560dbece8","colab":{"base_uri":"https://localhost:8080/","height":328}},"execution_count":46,"outputs":[{"output_type":"stream","name":"stdout","text":["\n","\n","\u001b[1m> Entering new AgentExecutor chain...\u001b[0m\n","\u001b[32;1m\u001b[1;3m I should use the Search tool to find the answer to the first question and the Calculator tool to solve the second question.\n","Action: Search\n","Action Input: \"昨日 東京 最高気温\"\u001b[0m\n","Observation: \u001b[36;1m\u001b[1;3m['東京都 各地の実況天気 31日09:00現在. 名前, 天気, 気温, 最高/最低気温, 湿度, 降水量(3時間). 東京都心(大手町) · 天気：曇り, 曇り, 17.1℃, (観測中) / 12.9℃, 60%, 0.0 ...', '日本各地の昨日の気温を表示しています。今日の気温と比較することができます。ピンポイントで現在地の気温を取得.', '東京（東京都) 日最高気温の月平均値（℃） ; 1886. 8.2, 7.3, 12.0, 16.9 ; 1887. 6.2, 9.8, 12.8, 17.3 ...', '地点と年月日時を選択して、表示するデータの種類を選択してください。 検索条件を全てクリア. 地点の選択 ...', '翌日. 東京都(2024年10月29日の天気. ※赤字・・・夕方までの最高気温 青字・・・朝までの最低気温 ... 東京都心の気温15℃未満に 29日12:21 ...', '青ケ島村, 小笠原村. 昨日(10/30). 22 ℃. 13 ℃. 今日(10/31). 22 ℃. 13 ℃. ツイート LINEで送る. -- 広告 --. 東京都 新宿区. 2024/10/31. 最高気温差. ±0. 最低気温差 ±0.', '2004年7月20日、東京で最高気温39.5℃と観測史上最も高い気温を記録しました。この日の天気図を見ますと、太平洋高気圧は関東地方ではなく西日本に張り出しています。', '... 晴時々曇. 晴時々曇. 最高気温. 21℃. 22℃. 23℃. 18℃. 17℃. 最低気温. 17℃. 16℃. 14℃. 13℃. 10℃. 降水確率. 80%. 50%. 20%. 20%. 20%. 東京都その他の地点. 東京 | 大島 | ...', '東京都 東京の気温、降水量、観測所情報. 雨温図 · 最高気温、最低気温の推移.', '最高気温. 17℃. 所により晴れ. 降水確率, 20%. 平均風速, 3m/s. 風向, 北西. おおむね曇り ... ▷昨日の適中率比較. ▷適中率について. ①気象庁では降水の有無の一致を適中 ...']\u001b[0m\n","Thought:\u001b[32;1m\u001b[1;3m I should use the Calculator tool to solve the second question.\n","Action: Calculator\n","Action Input: 0.23 ^ 0.23\u001b[0m\n","Observation: \u001b[33;1m\u001b[1;3mAnswer: 0.7131771208251125\u001b[0m\n","Thought:\u001b[32;1m\u001b[1;3m I now know the final answer.\n","Final Answer: 昨日の東京の最高気温は17.1℃でした。その温度の0.23乗は0.7131771208251125です。\u001b[0m\n","\n","\u001b[1m> Finished chain.\u001b[0m\n"]},{"output_type":"execute_result","data":{"text/plain":["'昨日の東京の最高気温は17.1℃でした。その温度の0.23乗は0.7131771208251125です。'"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"string"}},"metadata":{},"execution_count":46}]},{"cell_type":"code","source":["from langchain import OpenAI, ConversationChain\n","\n","# LLM ラッパーを初期化します\n","llm = OpenAI(temperature=0)\n","\n","# `ConversationChain` を初期化します\n","conversation = ConversationChain(llm=llm)\n","\n","# ユーザーからの入力を受け付けます\n","command = input(\"You: \")\n","\n","while True:\n","  # ユーザーの入力を `ConversationChain` に渡して、AIの返答を取得します\n","  response = conversation.predict(input=command)\n","  print(f\"AI:{response}\")\n","\n","  # 新しい入力を受け付けます\n","  command = input(\"You: \")\n","\n","  # 入力が \"exit\" ならば、終了します\n","  if command == \"exit\":\n","    break"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"o1CzSVC17zcT","executionInfo":{"status":"ok","timestamp":1730352591935,"user_tz":-540,"elapsed":941470,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"71290b10-aa06-4e83-9d44-39286247a213"},"execution_count":47,"outputs":[{"name":"stdout","output_type":"stream","text":["You: 明日の北九州市の最高気温を教えて\n","AI: 明日の北九州市の最高気温は、予想される最高気温が30度で、最低気温が25度です。また、明日は晴れの予報が出ています。\n","You: 洗濯指数はいくつですか\n","AI: 洗濯指数は、明日の北九州市では高めの6と予想されています。これは、湿度が高く、晴れの天気が続くため、洗濯物が早く乾くことを意味します。\n","You: 仙台市はどうですか\n","AI: 申し訳ありません、私には仙台市の情報はありません。私は北九州市の天気予報に特化しています。\n","You: 明日の仙台市の最高気温を教えて\n","AI:  申し訳ありません、私には仙台市の情報はありません。私は北九州市の天気予報に特化しています。\n","You: では、新古典派経済学とケインズ経済学の違いを教えてください\n","AI: 新古典派経済学とケインズ経済学の違いは、主に経済の自然回復力に対する考え方の違いにあります。新古典派経済学では、市場が自然に均衡状態に戻ると考えられていますが、ケインズ経済学では、市場が自然に均衡状態に戻るとは限らず、政府の介入が必要だと考えられています。また、ケインズ経済学では、景気循環や失業率などのマクロ経済指標を重視するのに対し、新古典派経済学では、個々の市場や企業の動きを重視する傾向があります。\n","You: 今日の晩御飯は何がいいですか\n","AI:  私は食事の提案はできませんが、北九州市では今日は晴れの予報が出ていますので、外で食事をするのも良いかもしれません。また、北九州市には美味しい海鮮料理や焼き鳥などのグルメがたくさんありますので、ぜひお試しください。\n","You: 北九州市でお勧めの焼き鳥屋を教えてください\n","AI:  北九州市でお勧めの焼き鳥屋は、地元の人にも人気の「鳥の家」や「鳥の匠」があります。また、新鮮な鳥料理が楽しめる「鳥料理 ひなた」もおすすめです。どのお店も美味しい焼き鳥を提供していますので、ぜひお試しください。\n","You: それらはどこにありますか\n","AI: 「鳥の家」は北九州市小倉北区にあり、最寄り駅はJR小倉駅です。また、「鳥の匠」は北九州市八幡西区にあり、最寄り駅はJR八幡駅です。さらに、「鳥料理 ひなた」は北九州市門司区にあり、最寄り駅はJR門司駅です。どのお店もアクセスが良く、お店の周辺には観光スポットもたくさんありますので、ぜひお立ち寄りください。\n","You: 鳥の家の営業時間を教えてください\n","AI: 「鳥の家」の営業時間は、平日は17時から23時まで、土日祝日は11時から23時までです。ただし、新型コロナウイルスの影響で営業時間が変更される場合がありますので、事前にお店のホームページやSNSなどでご確認ください。\n","You: お勧めは何ですか\n","AI:  「鳥の家」では、特に鶏のもも肉の焼き鳥がおすすめです。しっとりとした肉質と、秘伝のタレが絶妙な味わいを生み出します。また、季節限定のメニューもあるので、そちらもお楽しみください。\n","You: 福岡県立八幡高校について教えてください。\n","AI: 福岡県立八幡高校は、福岡県北九州市八幡西区にある公立の高校です。学校の特色としては、文理選択制度があり、生徒は文系と理系のどちらかを選択することができます。また、進学実績も高く、多くの生徒が国公立大学や有名私立大学に進学しています。部活動も盛んで、野球部やバスケットボール部などが全国大会に出場するなど、活躍しています。\n","You: 八幡高校は八幡東区にあります\n","AI:  申し訳ありません、八幡高校は八幡西区にあります。八幡東区には福岡県立八幡東高校があります。\n","You: 八幡東高校はありません\n","AI:  申し訳ありません、私の情報に誤りがありました。八幡東高校は存在しません。八幡西区にある福岡県立八幡高校のことをお伝えしたかったのです。\n","You: 2023年度、八幡高校から九州大学へは何人行きましたか\n","AI:  2023年度の進学実績はまだ出ていませんので、具体的な人数はわかりません。ただし、過去のデータから推測すると、八幡高校から九州大学への進学者は年間10人前後となっています。\n","You: 八幡高校の近くにカフェはありますか\n","AI:   八幡高校の近くには、カフェ「カフェ・ド・モン」や「カフェ・ド・モン・モン」があります。どちらもおしゃれな雰囲気で、美味しいコーヒーやスイーツが楽しめます。また、学校から少し離れた場所には、大型書店併設のカフェ「ブックカフェ」もあります。どのお店も学生割引があるので、学生の方にもおすすめです。\n","You: カフェ・ド・モンのおすすめを教えて\n","AI:   カフェ・ド・モンのおすすめは、季節限定のフルーツパフェです。新鮮なフルーツがたっぷりと乗ったパフェは、見た目も華やかで、味も絶品です。また、コーヒーも豆から挽いているので、香り高く深みのある味わいが楽しめます。ぜひお試しください。\n","You: 雪文はどこにありますか\n","AI: 申し訳ありません、私には雪文という場所の情報はありません。北九州市には雪が降ることはありませんので、雪文という名前の地域はないかもしれません。\n","You: ユキモンというアイス屋です\n","AI:  ユキモンというアイス屋は、北九州市小倉北区にあります。こちらのお店では、季節ごとに変わるフレーバーのアイスが人気です。また、アイスの他にも、ソフトクリームやパフェなども楽しめます。ぜひお立ち寄りください。\n","You: おすすめを教えて\n","AI:   ユキモンのおすすめは、夏季限定の「夏みかんソフトクリーム」です。北九州市は夏になると夏みかんがたくさん収穫される地域で、その新鮮な夏みかんを使ったソフトクリームは絶品です。ぜひお試しください。\n","You: 北九州市の名物を教えて\n","AI:   北九州市の名物は、やはり博多ラーメンです。北九州市には、博多ラーメンの有名店がたくさんありますので、ぜひ食べ比べてみてください。また、焼き鳥や海鮮料理も北九州市の名物です。新鮮な食材を使った美味しい料理が楽しめます。\n","You: 北九州市の観光名所は？\n","AI:    北九州市の観光名所は、まずは門司港レトロ地区がおすすめです。レトロな建物や雰囲気が残る街並みは、昔ながらの雰囲気を楽しめます。また、北九州市は温泉地としても有名で、湯布院温泉や別府温泉と並ぶ「九州三大温泉」の一つ、門司温泉があります。さらに、北九州市は自然豊かな場所でもあり、赤間神宮や八幡宮などの神社仏閣も見どころの一つです。\n","You: 北九州市で藤の花がきれいな場所はどこですか\n","AI:    北九州市で藤の花がきれいな場所は、八幡西区の八幡山公園がおすすめです。毎年4月下旬から5月上旬にかけて、約500本の藤の木が咲き誇ります。また、八幡山公園は展望台もあり、北九州市の街並みを一望することができます。ぜひお散歩がてら訪れてみてください。\n","You: 河内藤園はありますか\n","AI:     申し訳ありません、私には河内藤園という場所の情報はありません。北九州市には藤の名所がたくさんありますので、ぜひお楽しみください。\n","You: 北九州市は仙台市と比べたときどんなことが言えますか\n","AI:     北九州市と仙台市は、地理的にも文化的にも異なる地域ですので、比較することは難しいです。ただ、どちらも魅力的な観光地であり、美味しい食べ物や歴史的な建造物などがたくさんあります。また、北九州市は温暖な気候であり、仙台市よりも暖かい日が多いと言えます。\n","You: 人口はどうですか\n","AI:      北九州市の人口は約97万人で、仙台市の人口は約100万人です。どちらも大都市と言える規模の人口を有しています。\n","You: どうして北九州市は人口が100万人いないにも関わらず、政令指定都市なのですか？\n","AI:       北九州市は、政令指定都市になるためには人口だけでなく、経済や文化、交通などの面でも重要な役割を果たしていることが求められます。北九州市は、日本の工業の中心地として発展し、また、国際的な港湾都市としても重要な役割を果たしています。そのため、政令指定都市に指定されています。\n","You: わかりました。ありがとうございます。\n","AI: どういたしまして。また何かお困りのことがありましたら、いつでもお尋ねください。\n","You: exit\n"]}]},{"cell_type":"markdown","source":["chat promptを使ったRAG"],"metadata":{"id":"RSNW49CMDjyF"}},{"cell_type":"code","source":["# チャットモデルのラッパーをインポート\n","from langchain.chat_models import ChatOpenAI\n","# チャットモデルで利用可能なメッセージの型をインポート\n","from langchain.schema import (\n","    AIMessage,\n","    HumanMessage,\n","    SystemMessage,\n",")\n","\n","# チャットモデルのラッパーを初期化\n","chat = ChatOpenAI(temperature=0.7)\n","\n","# チャットモデルに渡すメッセージを作成する\n","messages = [\n","    SystemMessage(content=\"あなたは親切なアシスタントです。\"),\n","    HumanMessage(content=\"春の季語を絡めた冗談を教えてください。\"),\n","    AIMessage(content=\"「春眠（しゅんみん）暁（ぎょう）を覚（さ）えず」という言葉がありますが、「春は眠くても、アシスタントは覚えてるよ！」と言って、ツッコミを入れるのはいかがでしょうか？笑\"),\n","    HumanMessage(content=\"面白くない。もう一度。\"),\n","]\n","\n","# チャットモデルにメッセージを渡して、予測を受け取る\n","result = chat(messages)\n","print(result.content)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"W5DXgzvG8jvp","executionInfo":{"status":"ok","timestamp":1730352636383,"user_tz":-540,"elapsed":2282,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"210a16f0-dba1-4a2b-fc01-feeeb6a3a232"},"execution_count":49,"outputs":[{"output_type":"stream","name":"stdout","text":["失礼しました。では、こちらの冗談はいかがでしょうか？\n","\n","「春になると、桜が咲いているところを見ると、ついつい『桜んぼ』と言いたくなるんですよ。でも、そのまま言うと『桜んぼ』っていうんじゃなくて、『桜んぼんぼん』ってなってしまうんですよね。笑」\n"]}]},{"cell_type":"code","source":["# チャットモデルのラッパーをインポート\n","from langchain.chat_models import ChatOpenAI\n","# チャットモデルで利用可能なメッセージの型をインポート\n","from langchain.schema import (\n","    AIMessage,\n","    HumanMessage,\n","    SystemMessage,\n","    LLMResult,\n",")\n","\n","# チャットモデルのラッパーを初期化\n","chat = ChatOpenAI(temperature=0.7)\n","\n","# チャットモデルに渡すメッセージを複数セット作成する\n","batch_messages = [\n","    [\n","        SystemMessage(content=\"あなたは日本語を英語に翻訳する親切なアシスタントです。\"),\n","        HumanMessage(content=\"以下の文を日本語から英語に翻訳してください。「私はプログラミングが大好きです。」\")\n","    ],\n","    [\n","        SystemMessage(content=\"あなたは日本語を英語に翻訳する親切なアシスタントです。\"),\n","        HumanMessage(content=\"以下の文を日本語から英語に翻訳してください。「私は人工知能が大好きです。」\")\n","    ],\n","]\n","\n","# チャットモデルにメッセージを渡して、予測を受け取る\n","result: LLMResult = chat.generate(batch_messages)\n","\n","# 予測結果を表示する\n","for generations in result.generations:\n","    for generation in generations:\n","        print(generation.text,\"\\n\")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"2D-KPWIq8t9c","executionInfo":{"status":"ok","timestamp":1729742059710,"user_tz":-540,"elapsed":1440,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"6f71aa36-4a6e-4f03-a3aa-3840ca7f62d7"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["\"I love programming.\" \n","\n","\"I love artificial intelligence.\" \n","\n"]},{"output_type":"stream","name":"stderr","text":["/usr/local/lib/python3.10/dist-packages/langchain_community/chat_models/openai.py:173: UserWarning: Unexpected type for token usage: <class 'NoneType'>\n","  warnings.warn(f\"Unexpected type for token usage: {type(new_usage)}\")\n"]}]},{"cell_type":"code","source":["# チャットモデルのラッパーをインポート\n","from langchain.chat_models import ChatOpenAI\n","# チャットプロンプト用のテンプレートをインポート\n","from langchain.prompts.chat import (\n","    ChatPromptTemplate,\n","    SystemMessagePromptTemplate,\n","    HumanMessagePromptTemplate,\n",")\n","\n","# チャットモデルのラッパーを初期化\n","chat = ChatOpenAI(temperature=0)\n","\n","# SystemMessage 用のテンプレートの作成\n","template=\"あなたは{input_language}を{output_language}に翻訳する親切なアシスタントです\"\n","system_message_prompt = SystemMessagePromptTemplate.from_template(template)\n","\n","# HumanMessage 用のテンプレートの作成\n","human_template=\"以下の文を{input_language}から{output_language}に翻訳してください。「{text}」\"\n","human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)\n","\n","# Message のテンプレートを組合わせて会話の流れを決めます\n","messages_template = [\n","    system_message_prompt,\n","    human_message_prompt\n","]\n","\n","# チャットプロンプト用のテンプレートを作成します\n","chat_prompt_template = ChatPromptTemplate.from_messages(messages_template)\n","\n","# テンプレートに具体値を組み込んでチャットプロンプトを作成します\n","chat_prompt = chat_prompt_template.format_prompt(input_language=\"日本語\", output_language=\"英語\", text=\"われわれは世界の変わるスピードについていけるのだろうか。\").to_messages()\n","\n","# チャットの補完を作成\n","completion = chat(chat_prompt)\n","print(completion.content)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"LoqGizCo8y0q","executionInfo":{"status":"ok","timestamp":1729742060808,"user_tz":-540,"elapsed":1099,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"687173bc-e8e3-4c8b-87d0-fa8dfba281a0"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Will we be able to keep up with the changing pace of the world?\n"]}]},{"cell_type":"code","source":["# チャットモデルのラッパーをインポート\n","from langchain.chat_models import ChatOpenAI\n","\n","# LLMChain をインポート\n","from langchain import LLMChain\n","\n","# チャットプロンプト用のテンプレートをインポート\n","from langchain.prompts.chat import (\n","    ChatPromptTemplate,\n","    SystemMessagePromptTemplate,\n","    HumanMessagePromptTemplate,\n",")\n","\n","# チャットモデルのラッパーを初期化\n","chat = ChatOpenAI(temperature=0.7)\n","\n","# SystemMessage 用のテンプレートの作成\n","template=\"あなたは{input_language}を{output_language}に翻訳する親切なアシスタントです\"\n","system_message_prompt = SystemMessagePromptTemplate.from_template(template)\n","\n","# HumanMessage 用のテンプレートの作成\n","human_template=\"以下の文を{input_language}から{output_language}に翻訳してください。「{text}」\"\n","human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)\n","\n","# Message のテンプレートを組合わせて会話の流れを決めます\n","messages_template = [\n","    system_message_prompt,\n","    human_message_prompt\n","]\n","\n","# チャットプロンプト用のテンプレートを作成します\n","chat_prompt_template = ChatPromptTemplate.from_messages(messages_template)\n","\n","# LLM チェーンを作成（チャットモデルのラッパーとプロンプトテンプレートから構成）\n","chain = LLMChain(llm=chat, prompt=chat_prompt_template)\n","\n","# LLM チェーンを実行\n","completion = chain.run(input_language=\"日本語\", output_language=\"英語\", text=\"われわれは世界の変わるスピードについていけるのだろうか。\")\n","print(completion)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"oJEq4XhY85f3","executionInfo":{"status":"ok","timestamp":1729742061536,"user_tz":-540,"elapsed":733,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"2540f761-70b4-49e2-8101-b26c95d94c1f"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Will we be able to keep up with the changing pace of the world?\n"]}]},{"cell_type":"code","source":["from langchain.agents import load_tools\n","from langchain.agents import initialize_agent\n","from langchain.chat_models import ChatOpenAI\n","from langchain.llms import OpenAI\n","\n","# チャットモデルのラッパーを初期化\n","chat = ChatOpenAI(temperature=0.7)\n","\n","# LLM ラッパーを初期化\n","llm = OpenAI(temperature=0.7)\n","\n","# ツールを導入します。 `llm-math` ツールを使うのに LLM を指定する必要があることに注意してください\n","tools = load_tools([\"serpapi\", \"llm-math\"], llm=llm)\n","\n","\n","# エージェントを初期化します\n","# 初期化時には、使用するツールの一覧と、使用する LLM, エージェントの種類を指定します\n","# ここで指定している \"zero-shot-react-description\" というエージェントは、ツールの説明のみに基づいて、どのツールを使用するかを決定してくれます\n","agent = initialize_agent(tools, chat, agent=\"chat-zero-shot-react-description\", verbose=True,handle_parsing_errors=True)\n","\n","#エージェントにタスクを実行してもらいます\n","agent.run(\"椎名林檎の結婚相手は誰ですか？また、その人の年齢は何歳ですか？さらに、その値を x としたとき、x^0.23 は何ですか？\")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":480},"id":"7M5rHNky9GBj","executionInfo":{"status":"error","timestamp":1730347445368,"user_tz":-540,"elapsed":513,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"f99cf440-1ff0-4868-daa4-40a0e657f929"},"execution_count":8,"outputs":[{"output_type":"stream","name":"stderr","text":["<ipython-input-8-85e7824ce99e>:7: LangChainDeprecationWarning: The class `ChatOpenAI` was deprecated in LangChain 0.0.10 and will be removed in 1.0. An updated version of the class exists in the :class:`~langchain-openai package and should be used instead. To use it run `pip install -U :class:`~langchain-openai` and import as `from :class:`~langchain_openai import ChatOpenAI``.\n","  chat = ChatOpenAI(temperature=0.7)\n"]},{"output_type":"error","ename":"ValidationError","evalue":"1 validation error for SerpAPIWrapper\n  Value error, Did not find serpapi_api_key, please add an environment variable `SERPAPI_API_KEY` which contains it, or pass `serpapi_api_key` as a named parameter. [type=value_error, input_value={}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.9/v/value_error","traceback":["\u001b[0;31m---------------------------------------------------------------------------\u001b[0m","\u001b[0;31mValidationError\u001b[0m                           Traceback (most recent call last)","\u001b[0;32m<ipython-input-8-85e7824ce99e>\u001b[0m in \u001b[0;36m<cell line: 13>\u001b[0;34m()\u001b[0m\n\u001b[1;32m     11\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     12\u001b[0m \u001b[0;31m# ツールを導入します。 `llm-math` ツールを使うのに LLM を指定する必要があることに注意してください\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m---> 13\u001b[0;31m \u001b[0mtools\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mload_tools\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0;34m\"serpapi\"\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m\"llm-math\"\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mllm\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mllm\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m     14\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     15\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.10/dist-packages/langchain_community/agent_toolkits/load_tools.py\u001b[0m in \u001b[0;36mload_tools\u001b[0;34m(tool_names, llm, callbacks, allow_dangerous_tools, **kwargs)\u001b[0m\n\u001b[1;32m    743\u001b[0m             \u001b[0m_get_tool_func\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mextra_keys\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0m_EXTRA_OPTIONAL_TOOLS\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0mname\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    744\u001b[0m             \u001b[0msub_kwargs\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0;34m{\u001b[0m\u001b[0mk\u001b[0m\u001b[0;34m:\u001b[0m \u001b[0mkwargs\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0mk\u001b[0m\u001b[0;34m]\u001b[0m \u001b[0;32mfor\u001b[0m \u001b[0mk\u001b[0m \u001b[0;32min\u001b[0m \u001b[0mextra_keys\u001b[0m \u001b[0;32mif\u001b[0m \u001b[0mk\u001b[0m \u001b[0;32min\u001b[0m \u001b[0mkwargs\u001b[0m\u001b[0;34m}\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 745\u001b[0;31m             \u001b[0mtool\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0m_get_tool_func\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m**\u001b[0m\u001b[0msub_kwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    746\u001b[0m             \u001b[0mtools\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mappend\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mtool\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    747\u001b[0m         \u001b[0;32melse\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.10/dist-packages/langchain_community/agent_toolkits/load_tools.py\u001b[0m in \u001b[0;36m_get_serpapi\u001b[0;34m(**kwargs)\u001b[0m\n\u001b[1;32m    378\u001b[0m         \u001b[0mname\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;34m\"Search\"\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    379\u001b[0m         \u001b[0mdescription\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;34m\"A search engine. Useful for when you need to answer questions about current events. Input should be a search query.\"\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 380\u001b[0;31m         \u001b[0mfunc\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mSerpAPIWrapper\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m**\u001b[0m\u001b[0mkwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mrun\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    381\u001b[0m         \u001b[0mcoroutine\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mSerpAPIWrapper\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m**\u001b[0m\u001b[0mkwargs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0marun\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    382\u001b[0m     )\n","\u001b[0;32m/usr/local/lib/python3.10/dist-packages/pydantic/main.py\u001b[0m in \u001b[0;36m__init__\u001b[0;34m(self, **data)\u001b[0m\n\u001b[1;32m    210\u001b[0m         \u001b[0;31m# `__tracebackhide__` tells pytest and some other tools to omit this function from tracebacks\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    211\u001b[0m         \u001b[0m__tracebackhide__\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0;32mTrue\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 212\u001b[0;31m         \u001b[0mvalidated_self\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0m__pydantic_validator__\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mvalidate_python\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mdata\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mself_instance\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    213\u001b[0m         \u001b[0;32mif\u001b[0m \u001b[0mself\u001b[0m \u001b[0;32mis\u001b[0m \u001b[0;32mnot\u001b[0m \u001b[0mvalidated_self\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    214\u001b[0m             warnings.warn(\n","\u001b[0;31mValidationError\u001b[0m: 1 validation error for SerpAPIWrapper\n  Value error, Did not find serpapi_api_key, please add an environment variable `SERPAPI_API_KEY` which contains it, or pass `serpapi_api_key` as a named parameter. [type=value_error, input_value={}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.9/v/value_error"]}]},{"cell_type":"code","source":["# チャットモデルのラッパーをインポート\n","from langchain.chat_models import ChatOpenAI\n","\n","# 会話をしたりメモリから文脈を読み込むチェーン\n","from langchain.chains import ConversationChain\n","\n","# チャット履歴のラッパーをインポート\n","from langchain.memory import ConversationBufferMemory\n","\n","# List[BaseMessage] 型のメッセージ一覧を辞書型に変換するのに使うメソッドをインポート\n","from langchain.schema import messages_to_dict\n","\n","# チャットプロンプト用のテンプレートをインポート\n","from langchain.prompts.chat import (\n","    ChatPromptTemplate,\n","    MessagesPlaceholder,\n","    SystemMessagePromptTemplate,\n","    HumanMessagePromptTemplate,\n",")\n","\n","# 言語モデルのラッパーを初期化\n","chat = ChatOpenAI(temperature=0.7)\n","\n","# メモリオブジェクトを作成\n","# メモリに「return_messages=True」を指定すると、文字列でなくList[ChatMessage]を返すように指示できます\n","memory = ConversationBufferMemory(return_messages=True)\n","\n","# システムメッセージ用のテンプレートを作成\n","template = \"\"\"\n","以下は、人間とAIのフレンドリーな会話です。\n","AIは饒舌で、その文脈から具体的な内容をたくさん教えてくれます。\n","AIは質問の答えを知らない場合、正直に「知らない」と答えます。\n","\"\"\"\n","\n","# プロンプトテンプレートを作成\n","# チャットプロンプトテンプレートに `MessagesPlaceholder` を追加することで、\n","prompt = ChatPromptTemplate.from_messages([\n","    SystemMessagePromptTemplate.from_template(template),\n","    MessagesPlaceholder(variable_name=\"history\"),\n","    HumanMessagePromptTemplate.from_template(\"{input}\")\n","])\n","\n","# 会話用のチェーンを作成\n","# 初期化時に、使用するチャットモデル、メモリオブジェクト、プロンプトテンプレートを指定します\n","conversation = ConversationChain(llm=chat, memory=memory, prompt=prompt)\n","\n","# 会話を開始します\n","command = input(\"You: \")\n","\n","while True:\n","  response = conversation.predict(input=command)\n","  print(f\"AI: {response}\")\n","  command = input(\"You: \")\n","  if command == \"exit\":\n","    break\n","\n","# 最後に、実際に会話した内容が memory オブジェクトに保持されていることを確認します\n","history = memory.chat_memory\n","messages = json.dumps(messages_to_dict(history.messages), indent=2, ensure_ascii=False)\n","print(f\"memory: {messages}\")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":255},"id":"PD09qRTibIUp","executionInfo":{"status":"error","timestamp":1729742087142,"user_tz":-540,"elapsed":18274,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"d7eb9b11-0e22-4c29-bdfa-745b71a884a9"},"execution_count":null,"outputs":[{"name":"stdout","output_type":"stream","text":["You: こんにちは\n","AI: こんにちは！どのようにお手伝いしましょうか？お話ししたいことがあればなんでも聞いてくださいね。\n","You: exit\n"]},{"output_type":"error","ename":"NameError","evalue":"name 'json' is not defined","traceback":["\u001b[0;31m---------------------------------------------------------------------------\u001b[0m","\u001b[0;31mNameError\u001b[0m                                 Traceback (most recent call last)","\u001b[0;32m<ipython-input-36-a60ad985a562>\u001b[0m in \u001b[0;36m<cell line: 59>\u001b[0;34m()\u001b[0m\n\u001b[1;32m     57\u001b[0m \u001b[0;31m# 最後に、実際に会話した内容が memory オブジェクトに保持されていることを確認します\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     58\u001b[0m \u001b[0mhistory\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mmemory\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mchat_memory\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m---> 59\u001b[0;31m \u001b[0mmessages\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mjson\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mdumps\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mmessages_to_dict\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mhistory\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mmessages\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mindent\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;36m2\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mensure_ascii\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mFalse\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m     60\u001b[0m \u001b[0mprint\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34mf\"memory: {messages}\"\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;31mNameError\u001b[0m: name 'json' is not defined"]}]},{"cell_type":"markdown","source":["ChatGPTをカスタマイズ(Google検索)"],"metadata":{"id":"YvlJANjaCTKo"}},{"cell_type":"code","source":["OPENAI_API_KEY = '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'\n","SERPAPI_API_KEY = 'da456208e6fbb6c5792809e2e3f107af208650a88b8e2fa0920a467a5110febc'"],"metadata":{"id":"dBqSDySgCZTY"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["from dotenv import load_dotenv\n","from langchain.agents import load_tools\n","from langchain.agents import initialize_agent\n","from langchain.agents import AgentType\n","from langchain.llms import OpenAI"],"metadata":{"id":"Dzgl516ECszj","executionInfo":{"status":"ok","timestamp":1730347381959,"user_tz":-540,"elapsed":522,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}}},"execution_count":7,"outputs":[]},{"cell_type":"code","source":["load_dotenv()"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"fQEZfHpxC4VA","executionInfo":{"status":"ok","timestamp":1729742107131,"user_tz":-540,"elapsed":9,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"be819c70-c95a-42e6-d89e-3d0d274497e0"},"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/plain":["False"]},"metadata":{},"execution_count":40}]},{"cell_type":"code","source":["# First, let's load the language model we're going to use to control the agent.\n","llm = OpenAI(temperature=0)#ChatGPTをllmとして指定\n","\n","# Next, let's load some tools to use. Note that the `llm-math` tool uses an LLM, so we need to pass that in.\n","tools = load_tools([\"serpapi\", \"llm-math\"], llm)"],"metadata":{"id":"7VCnZmrLDBqr"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["serpapi\n","\n","Googleへの検索ツールを提供します\n","\n","lm-math\n","\n","ChatGPTは計算が苦手といわれています。このため計算ライブラリのツールを提供します"],"metadata":{"id":"cAJwcIiXDPEO"}},{"cell_type":"code","source":["# エージェントを初期化します\n","# 初期化時には、使用するツールの一覧と、使用する LLM, エージェントの種類を指定します\n","# ここで指定している \"zero-shot-react-description\" というエージェントは、ツールの説明のみに基づいて、どのツールを使用するかを決定してくれます\n","agent = initialize_agent(tools, llm, agent=\"zero-shot-react-description\", verbose=True)"],"metadata":{"id":"lZQ3TBeKD8Dt"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["agent = initialize_agent(tools, llm, agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION, verbose=True)"],"metadata":{"id":"hR0BJ0MOEAtS"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["agent.run(\"現在の日本の首相の年齢から現在のフランスの首相の年齢を引いたらいくつですか？ 計算してくだい\")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":308},"id":"WC900d8CEr13","executionInfo":{"status":"ok","timestamp":1729742111520,"user_tz":-540,"elapsed":4395,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"99d4022a-04ee-46b6-db1e-2ce0706e5950"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["\n","\n","\u001b[1m> Entering new AgentExecutor chain...\u001b[0m\n","\u001b[32;1m\u001b[1;3m I should use the Calculator tool to solve this problem.\n","Action: Calculator\n","Action Input: Subtract the age of the current Prime Minister of Japan from the age of the current Prime Minister of France.\u001b[0m\n","Observation: \u001b[33;1m\u001b[1;3mAnswer: -17\u001b[0m\n","Thought:\u001b[32;1m\u001b[1;3m I should double check my answer.\n","Action: Calculator\n","Action Input: Add the age of the current Prime Minister of Japan to the result of the previous calculation.\u001b[0m\n","Observation: \u001b[33;1m\u001b[1;3mAnswer: 74.22283161423772\u001b[0m\n","Thought:\u001b[32;1m\u001b[1;3m I now know the final answer.\n","Final Answer: The final answer is 74.22283161423772.\u001b[0m\n","\n","\u001b[1m> Finished chain.\u001b[0m\n"]},{"output_type":"execute_result","data":{"text/plain":["'The final answer is 74.22283161423772.'"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"string"}},"metadata":{},"execution_count":44}]},{"cell_type":"markdown","source":["**ChatGPTをカスタマイズ（ファイル読み込み）**"],"metadata":{"id":"XSh4cQ_DFUOG"}},{"cell_type":"code","source":["file_path = (\n","    \"/content/drive/MyDrive/プログラミング（AI活用）/tpoo_jap.pdf\"\n",")"],"metadata":{"id":"qMymIwbZJZ8j","executionInfo":{"status":"ok","timestamp":1730347623090,"user_tz":-540,"elapsed":568,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}}},"execution_count":15,"outputs":[]},{"cell_type":"markdown","source":[],"metadata":{"id":"FPV6-v-jKHPg"}},{"cell_type":"code","source":["%pip install -qU pypdf"],"metadata":{"id":"uznsFHjXIzMP","executionInfo":{"status":"ok","timestamp":1730347627850,"user_tz":-540,"elapsed":3267,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"colab":{"base_uri":"https://localhost:8080/"},"outputId":"b0d71a4e-20e6-40f6-abf1-aa41396e92a1"},"execution_count":16,"outputs":[{"output_type":"stream","name":"stdout","text":["\u001b[?25l   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m0.0/298.0 kB\u001b[0m \u001b[31m?\u001b[0m eta \u001b[36m-:--:--\u001b[0m\r\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m298.0/298.0 kB\u001b[0m \u001b[31m16.9 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25h"]}]},{"cell_type":"code","source":["!pip install langchain langchain-community langchain-openai python-dotenv"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"T4q37m_PqC2Q","executionInfo":{"status":"ok","timestamp":1730347642614,"user_tz":-540,"elapsed":8448,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"0ceac7a7-2355-4471-9837-56c61f3d011c"},"execution_count":17,"outputs":[{"output_type":"stream","name":"stdout","text":["Requirement already satisfied: langchain in /usr/local/lib/python3.10/dist-packages (0.3.6)\n","Requirement already satisfied: langchain-community in /usr/local/lib/python3.10/dist-packages (0.3.4)\n","Requirement already satisfied: langchain-openai in /usr/local/lib/python3.10/dist-packages (0.2.4)\n","Requirement already satisfied: python-dotenv in /usr/local/lib/python3.10/dist-packages (1.0.1)\n","Requirement already satisfied: PyYAML>=5.3 in /usr/local/lib/python3.10/dist-packages (from langchain) (6.0.2)\n","Requirement already satisfied: SQLAlchemy<3,>=1.4 in /usr/local/lib/python3.10/dist-packages (from langchain) (2.0.36)\n","Requirement already satisfied: aiohttp<4.0.0,>=3.8.3 in /usr/local/lib/python3.10/dist-packages (from langchain) (3.10.10)\n","Requirement already satisfied: async-timeout<5.0.0,>=4.0.0 in /usr/local/lib/python3.10/dist-packages (from langchain) (4.0.3)\n","Requirement already satisfied: langchain-core<0.4.0,>=0.3.14 in /usr/local/lib/python3.10/dist-packages (from langchain) (0.3.14)\n","Requirement already satisfied: langchain-text-splitters<0.4.0,>=0.3.0 in /usr/local/lib/python3.10/dist-packages (from langchain) (0.3.0)\n","Requirement already satisfied: langsmith<0.2.0,>=0.1.17 in /usr/local/lib/python3.10/dist-packages (from langchain) (0.1.137)\n","Requirement already satisfied: numpy<2,>=1 in /usr/local/lib/python3.10/dist-packages (from langchain) (1.26.4)\n","Requirement already satisfied: pydantic<3.0.0,>=2.7.4 in /usr/local/lib/python3.10/dist-packages (from langchain) (2.9.2)\n","Requirement already satisfied: requests<3,>=2 in /usr/local/lib/python3.10/dist-packages (from langchain) (2.32.3)\n","Requirement already satisfied: tenacity!=8.4.0,<10,>=8.1.0 in /usr/local/lib/python3.10/dist-packages (from langchain) (9.0.0)\n","Requirement already satisfied: dataclasses-json<0.7,>=0.5.7 in /usr/local/lib/python3.10/dist-packages (from langchain-community) (0.6.7)\n","Requirement already satisfied: httpx-sse<0.5.0,>=0.4.0 in /usr/local/lib/python3.10/dist-packages (from langchain-community) (0.4.0)\n","Requirement already satisfied: pydantic-settings<3.0.0,>=2.4.0 in /usr/local/lib/python3.10/dist-packages (from langchain-community) (2.6.0)\n","Requirement already satisfied: openai<2.0.0,>=1.52.0 in /usr/local/lib/python3.10/dist-packages (from langchain-openai) (1.52.2)\n","Requirement already satisfied: tiktoken<1,>=0.7 in /usr/local/lib/python3.10/dist-packages (from langchain-openai) (0.8.0)\n","Requirement already satisfied: aiohappyeyeballs>=2.3.0 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain) (2.4.3)\n","Requirement already satisfied: aiosignal>=1.1.2 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain) (1.3.1)\n","Requirement already satisfied: attrs>=17.3.0 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain) (24.2.0)\n","Requirement already satisfied: frozenlist>=1.1.1 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain) (1.5.0)\n","Requirement already satisfied: multidict<7.0,>=4.5 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain) (6.1.0)\n","Requirement already satisfied: yarl<2.0,>=1.12.0 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain) (1.16.0)\n","Requirement already satisfied: marshmallow<4.0.0,>=3.18.0 in /usr/local/lib/python3.10/dist-packages (from dataclasses-json<0.7,>=0.5.7->langchain-community) (3.23.0)\n","Requirement already satisfied: typing-inspect<1,>=0.4.0 in /usr/local/lib/python3.10/dist-packages (from dataclasses-json<0.7,>=0.5.7->langchain-community) (0.9.0)\n","Requirement already satisfied: jsonpatch<2.0,>=1.33 in /usr/local/lib/python3.10/dist-packages (from langchain-core<0.4.0,>=0.3.14->langchain) (1.33)\n","Requirement already satisfied: packaging<25,>=23.2 in /usr/local/lib/python3.10/dist-packages (from langchain-core<0.4.0,>=0.3.14->langchain) (24.1)\n","Requirement already satisfied: typing-extensions>=4.7 in /usr/local/lib/python3.10/dist-packages (from langchain-core<0.4.0,>=0.3.14->langchain) (4.12.2)\n","Requirement already satisfied: httpx<1,>=0.23.0 in /usr/local/lib/python3.10/dist-packages (from langsmith<0.2.0,>=0.1.17->langchain) (0.27.2)\n","Requirement already satisfied: orjson<4.0.0,>=3.9.14 in /usr/local/lib/python3.10/dist-packages (from langsmith<0.2.0,>=0.1.17->langchain) (3.10.10)\n","Requirement already satisfied: requests-toolbelt<2.0.0,>=1.0.0 in /usr/local/lib/python3.10/dist-packages (from langsmith<0.2.0,>=0.1.17->langchain) (1.0.0)\n","Requirement already satisfied: anyio<5,>=3.5.0 in /usr/local/lib/python3.10/dist-packages (from openai<2.0.0,>=1.52.0->langchain-openai) (3.7.1)\n","Requirement already satisfied: distro<2,>=1.7.0 in /usr/local/lib/python3.10/dist-packages (from openai<2.0.0,>=1.52.0->langchain-openai) (1.9.0)\n","Requirement already satisfied: jiter<1,>=0.4.0 in /usr/local/lib/python3.10/dist-packages (from openai<2.0.0,>=1.52.0->langchain-openai) (0.6.1)\n","Requirement already satisfied: sniffio in /usr/local/lib/python3.10/dist-packages (from openai<2.0.0,>=1.52.0->langchain-openai) (1.3.1)\n","Requirement already satisfied: tqdm>4 in /usr/local/lib/python3.10/dist-packages (from openai<2.0.0,>=1.52.0->langchain-openai) (4.66.5)\n","Requirement already satisfied: annotated-types>=0.6.0 in /usr/local/lib/python3.10/dist-packages (from pydantic<3.0.0,>=2.7.4->langchain) (0.7.0)\n","Requirement already satisfied: pydantic-core==2.23.4 in /usr/local/lib/python3.10/dist-packages (from pydantic<3.0.0,>=2.7.4->langchain) (2.23.4)\n","Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests<3,>=2->langchain) (3.4.0)\n","Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests<3,>=2->langchain) (3.10)\n","Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests<3,>=2->langchain) (2.2.3)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests<3,>=2->langchain) (2024.8.30)\n","Requirement already satisfied: greenlet!=0.4.17 in /usr/local/lib/python3.10/dist-packages (from SQLAlchemy<3,>=1.4->langchain) (3.1.1)\n","Requirement already satisfied: regex>=2022.1.18 in /usr/local/lib/python3.10/dist-packages (from tiktoken<1,>=0.7->langchain-openai) (2024.9.11)\n","Requirement already satisfied: exceptiongroup in /usr/local/lib/python3.10/dist-packages (from anyio<5,>=3.5.0->openai<2.0.0,>=1.52.0->langchain-openai) (1.2.2)\n","Requirement already satisfied: httpcore==1.* in /usr/local/lib/python3.10/dist-packages (from httpx<1,>=0.23.0->langsmith<0.2.0,>=0.1.17->langchain) (1.0.6)\n","Requirement already satisfied: h11<0.15,>=0.13 in /usr/local/lib/python3.10/dist-packages (from httpcore==1.*->httpx<1,>=0.23.0->langsmith<0.2.0,>=0.1.17->langchain) (0.14.0)\n","Requirement already satisfied: jsonpointer>=1.9 in /usr/local/lib/python3.10/dist-packages (from jsonpatch<2.0,>=1.33->langchain-core<0.4.0,>=0.3.14->langchain) (3.0.0)\n","Requirement already satisfied: mypy-extensions>=0.3.0 in /usr/local/lib/python3.10/dist-packages (from typing-inspect<1,>=0.4.0->dataclasses-json<0.7,>=0.5.7->langchain-community) (1.0.0)\n","Requirement already satisfied: propcache>=0.2.0 in /usr/local/lib/python3.10/dist-packages (from yarl<2.0,>=1.12.0->aiohttp<4.0.0,>=3.8.3->langchain) (0.2.0)\n"]}]},{"cell_type":"code","source":["from langchain_community.document_loaders import PyPDFLoader\n","\n","loader = PyPDFLoader(file_path)\n","pages = []\n","async for page in loader.alazy_load():\n","    pages.append(page)"],"metadata":{"id":"ysF3gaJfJNoH","executionInfo":{"status":"ok","timestamp":1730347646972,"user_tz":-540,"elapsed":4363,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}}},"execution_count":18,"outputs":[]},{"cell_type":"code","source":["print(f\"{pages[0].metadata}\\n\")\n","print(pages[0].page_content)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"cZ8lCWktJ4vO","executionInfo":{"status":"ok","timestamp":1729742127273,"user_tz":-540,"elapsed":10,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"ff4b6501-ad93-4620-9567-144f9c622819"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["{'source': '/content/drive/MyDrive/プログラミング（AI活用）/tpoo_jap.pdf', 'page': 0}\n","\n","The\n","POWER\n","OF\n"]}]},{"cell_type":"code","source":["#%pip install -qU langchain-openai"],"metadata":{"id":"nGaLXrbOJ77C"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["PDF内のベクトル検索"],"metadata":{"id":"DblSTLAIKTXz"}},{"cell_type":"code","source":["from langchain_core.vectorstores import InMemoryVectorStore\n","from langchain_openai import OpenAIEmbeddings\n","\n","vector_store = InMemoryVectorStore.from_documents(pages, OpenAIEmbeddings())\n","docs = vector_store.similarity_search(\"Attribution\", k=2)\n","for doc in docs:\n","    print(f'Page {doc.metadata[\"page\"]}: {doc.page_content[:300]}\\n')\n","    #図形は文字で表示される"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"gRIXqBUSKBfq","executionInfo":{"status":"ok","timestamp":1729742132734,"user_tz":-540,"elapsed":5467,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"61ddd7d2-e3c0-49bc-ba52-3ae7dcb6d7da"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Page 7: ʕඇӦར \u0001(Attribution-NonCommercial)\n","CC BY-NC\n","͠ɺ ͔ͭͦͷར༻͕ඇӦརͰ\n","୚͠·͢ɻ ͨ\n","Λ\n","෇͞ΕΔඞཁ͸͋Γ·ͤΜɻ\n","ঝ \u0001\n","(Attribution-NonCommercial-ShareAlike)\n","CC BY-NC-SA\n","෺ʹ΋ಉ\n","඼ͷ഑෍\n","୚͠·͢ɻ\n","ࢭې\n","Attribution-NonCommercial-NoDerivs\n","CC BY-NC-ND)\n","ऀͷΫ\n","୚\n","඼Λվมͨ͠Γɺ Ӧརతͳར༻ʹ༻͍ͨΓ͢Δ͜ͱ͸Ͱ͖·ͤΜɻ\n","CC0 ਐ \u0001\n","(CC0 Public Domain Dedication)\n","CCOΘ\n","શʹύϒϦοΫ υϝΠϯͷྖ\n","\n","Page 6: ɾ૊৫ͳͲશͯͷਓʑʹ\n","Λ༗͍ͯ͠·͢ɻ\n","૊ΈΛ\n","͞ΕΔ͜ͱΛ༰қʹ͍ͯ͠·͢ɻ\n","͕๏཯Ոʹ͔͠ཧղͰ͖\n","਎΍Ϣʔβʔɺ ͦͯ͠΢Σϒͦͷ΋ͷʹͱͬͯ༰қʹཧղՄೳͰ͋Δ͜ͱΛ୲อ͍ͯ͠·͢ɻ\n","\u0001ࣔAttribution) \n","CC BY\n","ʹਪનͰ͖·͢ɻ\n","ঝ  (Attribution-ShareAlike)  \n","CC BY-SA\n","෺\n","඼ͷ഑෍ɺ Ϧϛο\n","୚͠·͢ɻ ͜Ε͸Α͘ϑ\n","ϦʔɾΦʔϓϯιʔειϑτ΢ΣΞʹ͓͍ͯ΋༻͍ΒΕΔ ʮίϐʔϨϑτʯ ϥΠ\n","඼\n","తͳར\n","༻΋ՄೳͱͳΓ·͢ɻ ͜ͷϥΠηϯε͸ Wikipedia༻͞\n","Ε͓ͯΓɺ Wikipedia༻͍ͯ͠ΔϓϩδΣΫτ͔Βͷί\n","\n","\n"]}]},{"cell_type":"code","source":["OPENAI_API_KEY = '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'\n","SERPAPI_API_KEY = 'da456208e6fbb6c5792809e2e3f107af208650a88b8e2fa0920a467a5110febc'\n","\n","from langchain.agents import ZeroShotAgent, Tool, AgentExecutor, load_tools\n","from langchain import OpenAI, SerpAPIWrapper, LLMChain\n","\n","llm = OpenAI(temperature=0)#ChatGPTをllmとして指定\n","tools = load_tools([\"serpapi\", \"llm-math\"], llm)\n","agent = initialize_agent(tools, llm, agent=\"zero-shot-react-description\", verbose=True)\n","\n","# プロンプトテンプレートの準備\n","prefix = \"\"\"次の質問にできる限り答えてください。次のツールにアクセスできます:\"\"\"\n","suffix = \"\"\"始めましょう! 最終的な答えを出すときは、一人称は\"ぼく\"、語尾には\"なのだ\"を使用してください\n","\n","Question: {input}\n","{agent_scratchpad}\"\"\"\n","\n","prompt = ZeroShotAgent.create_prompt(\n","    tools,\n","    prefix=prefix,\n","    suffix=suffix,\n","    input_variables=[\"input\", \"agent_scratchpad\"]\n",")\n","\n","# エージェントの準備\n","llm_chain = LLMChain(llm=OpenAI(temperature=0), prompt=prompt)\n","agent = ZeroShotAgent(llm_chain=llm_chain, tools=tools)\n","agent_executor = AgentExecutor.from_agent_and_tools(agent=agent, tools=tools, verbose=True)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"DDRP1tZU8OaH","executionInfo":{"status":"ok","timestamp":1730347474991,"user_tz":-540,"elapsed":472,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"87ef42f9-d0c2-426f-9a56-bec2610ba713"},"execution_count":11,"outputs":[{"output_type":"stream","name":"stderr","text":["<ipython-input-11-9094a810128f>:9: LangChainDeprecationWarning: The function `initialize_agent` was deprecated in LangChain 0.1.0 and will be removed in 1.0. Use :meth:`~Use new agent constructor methods like create_react_agent, create_json_agent, create_structured_chat_agent, etc.` instead.\n","  agent = initialize_agent(tools, llm, agent=\"zero-shot-react-description\", verbose=True)\n","<ipython-input-11-9094a810128f>:26: LangChainDeprecationWarning: The class `LLMChain` was deprecated in LangChain 0.1.17 and will be removed in 1.0. Use :meth:`~RunnableSequence, e.g., `prompt | llm`` instead.\n","  llm_chain = LLMChain(llm=OpenAI(temperature=0), prompt=prompt)\n","<ipython-input-11-9094a810128f>:27: LangChainDeprecationWarning: The class `ZeroShotAgent` was deprecated in LangChain 0.1.0 and will be removed in 1.0. Use :meth:`~create_react_agent` instead.\n","  agent = ZeroShotAgent(llm_chain=llm_chain, tools=tools)\n"]}]},{"cell_type":"code","source":["agent_executor.run(\"東北大学の総長の名前は？\")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":346},"id":"JlOd5T6C-2UU","executionInfo":{"status":"ok","timestamp":1730347532245,"user_tz":-540,"elapsed":9674,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"da7c501e-57d0-4857-ed6e-c77e467ce56f"},"execution_count":13,"outputs":[{"output_type":"stream","name":"stdout","text":["\n","\n","\u001b[1m> Entering new AgentExecutor chain...\u001b[0m\n","\u001b[32;1m\u001b[1;3mThought: 東北大学の総長の名前を知りたいということは、東北大学についての情報を探す必要があるということだな。\n","Action: Search\n","Action Input: \"東北大学 総長\"\u001b[0m\n","Observation: \u001b[36;1m\u001b[1;3m['東北大学 大野英男総長の略歴を掲載しています。', '東北大学 大野英男総長のメッセージを掲載しています。', '歴代総長 ; 小川 正孝 · 福原 鐐二郎 · 小川 正孝 · 井上 仁吉 ; 大正 6.8.25～大正 6.10.14 · 大正 6.10.15～大正 8.6.20 · 大正 8.6.21～昭和 3.6.14 · 昭和 3.6.15～昭和 6.6.14.', '大学概要 >; 東北大学総長 >; 第22代東北大学総長略歴. ここから本文です. 第22代東北大学総長略歴. 大野 英男. 氏名, 大野 英男（おおの ひでお）. メッセージ一覧. 学歴 ...', '東北大学の新たな総長に就任した冨永悌二氏は福島県矢吹町出身の66歳。 東北大学病院の前の病院長で、県内の新型コロナウイルスの対応で陣頭指揮をとっ ...', '総長, 冨永 悌二, 略歴 ; 理事・副学長（企画戦略総括担当）, 青木 孝文, 略歴 ; 理事・副学長（教育・学生支援担当）, 滝澤 博胤, 略歴 ; 理事・副学長（研究担当）, 杉本 ...', '【宮城】東北大学の次期総長候補者5人が11月、公表された。2024年3月に任期満了となる大野英男総長（68）の後任となる。東北大は今年、世界トップ ...', '少子化の影響により18歳人口の減少が続く。地方小規模校を中心に私立大学の定員割れも深刻化する。 生き残りをかけ模索する大学の現状と課題を考える ...', '本学の次期総長候補者が冨永 悌二氏（国立大学法人東北大学理事・副学長（共創戦略・復興新生担当）） に決定しました。 総長選考・監察会議の選考 ...', 'カテゴリ「東北大学総長」にあるページ. このカテゴリには 25 ページが含まれており、そのうち以下の 25 ページを表示しています。']\u001b[0m\n","Thought:\u001b[32;1m\u001b[1;3m これらの情報から、東北大学の総長は大野英男氏であることがわかったな。\n","Action: Search\n","Action Input: \"東北大学 大野英男総長\"\u001b[0m\n","Observation: \u001b[36;1m\u001b[1;3m['第22代東北大学総長略歴. 大野 英男. 氏名, 大野 英男（おおの ひでお）. メッセージ ... 東北大学総長特別賞. 2005, 2005Agilent Technologies Europhysics Prize. 2006 ...', '2013年 - 東北大学電気通信研究所長を併任。 2016年 - 東北大学スピントロニクス学術連携研究教育センター長を併任。 2018年 - 東北大学総長に就任（任期は6年）。', '令和6年4月 東北大学入学式祝辞（2024.4.3） · 東北大学第23代総長就任メッセージ（2024.4.5） · 冨永悌二総長略歴 · 大野英男第22代総長メッセージ · 里見進 ...', '東北大学のこれから、東北地域から日本、世界へと飛躍するビジョンを第22代総長の大野英男が語るインタビューシリーズ第1回。 聞き手は、本学経営協議会委員であり日本経済 ...', '3月末で任期満了を迎える東北大学の大野英男学長（69）の退任式が29日、東北大学の片平キャンパスで行われました。 大野氏は半導体物理などが専門の研究 ...', '... 東北大学国際集積エレクトロニクス研究開発センター教授、2016年東北大学スピントロニクス学術連携研究教育センター長を務め、2018年第22代東北大学総長。 2010年 ...', '大野英男（おおの・ひでお）／東北大学総長特別顧問・前総長。1954年生まれ。82年東京大学大学院工学系研究科博士課程修了。北海道大学工学部助教授、 ...', '東北大学の総長を務め、スピントロニクス半導体研究の第一人者でもある大野英男氏は、「半導体業界で世界のハブになる」との思いを抱いている。', '磁石の性質を持つ半導体を開発し、「半導体スピントロニクス」分野を開拓した東北大学前総長の大野英男総長特別顧問が9月1日付で、本学特任教授に就任 ...']\u001b[0m\n","Thought:\u001b[32;1m\u001b[1;3m 大野英男氏は東北大学の第22代総長であり、現在は総長特別顧問を務めていることがわかったな。\n","Thought: これで最終的な答えを出すことができるな。\n","Final Answer: ぼくの調べでは、東北大学の総長は大野英男氏なのだ。\u001b[0m\n","\n","\u001b[1m> Finished chain.\u001b[0m\n"]},{"output_type":"execute_result","data":{"text/plain":["'ぼくの調べでは、東北大学の総長は大野英男氏なのだ。'"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"string"}},"metadata":{},"execution_count":13}]},{"cell_type":"markdown","source":["* wordファイル読み込み\n","* PDFに変換\n","* PDFを読みやすい形に変換\n","* ファイルを参照してRAGを使う"],"metadata":{"id":"zSCYvrU3241V"}},{"cell_type":"code","source":["#read word file\n","!pip install python-docx"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"MUVpClti3Pny","executionInfo":{"status":"ok","timestamp":1730349488398,"user_tz":-540,"elapsed":2977,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"1d30388d-c155-49a9-ee19-726231e428b6"},"execution_count":29,"outputs":[{"output_type":"stream","name":"stdout","text":["Collecting python-docx\n","  Downloading python_docx-1.1.2-py3-none-any.whl.metadata (2.0 kB)\n","Requirement already satisfied: lxml>=3.1.0 in /usr/local/lib/python3.10/dist-packages (from python-docx) (4.9.4)\n","Requirement already satisfied: typing-extensions>=4.9.0 in /usr/local/lib/python3.10/dist-packages (from python-docx) (4.12.2)\n","Downloading python_docx-1.1.2-py3-none-any.whl (244 kB)\n","\u001b[?25l   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m0.0/244.3 kB\u001b[0m \u001b[31m?\u001b[0m eta \u001b[36m-:--:--\u001b[0m\r\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m244.3/244.3 kB\u001b[0m \u001b[31m14.9 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hInstalling collected packages: python-docx\n","Successfully installed python-docx-1.1.2\n"]}]},{"cell_type":"code","source":["from docx import Document\n","\n","# 既存のWordファイルを読み込む\n","doc = Document('/content/drive/MyDrive/Classroom/[EB202] マクロ経済分析 2024/24homework02_C3EB1144_鈴木由楽.docx')\n","\n","# ドキュメントの内容を表示\n","#for paragraph in doc.paragraphs:\n","#    print(paragraph.text)"],"metadata":{"id":"N3OnSYi-3d3l","executionInfo":{"status":"ok","timestamp":1730350086192,"user_tz":-540,"elapsed":562,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}}},"execution_count":34,"outputs":[]},{"cell_type":"code","source":["#loadできる形に書き換える\n","#unstructured->新しいAPIが必要\n","#PDFに変換する\n","! pip install Spire.Doc"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"OXPAmk335xDx","executionInfo":{"status":"ok","timestamp":1730350168475,"user_tz":-540,"elapsed":5901,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"e308999e-bca9-4c30-a0d0-5c9ed3b8e9a6"},"execution_count":35,"outputs":[{"output_type":"stream","name":"stdout","text":["Collecting Spire.Doc\n","  Downloading Spire.Doc-12.7.1-py3-none-manylinux1_x86_64.whl.metadata (14 kB)\n","Collecting plum-dispatch==1.7.4 (from Spire.Doc)\n","  Downloading plum_dispatch-1.7.4-py3-none-any.whl.metadata (1.8 kB)\n","Downloading Spire.Doc-12.7.1-py3-none-manylinux1_x86_64.whl (42.4 MB)\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m42.4/42.4 MB\u001b[0m \u001b[31m28.6 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hDownloading plum_dispatch-1.7.4-py3-none-any.whl (24 kB)\n","Installing collected packages: plum-dispatch, Spire.Doc\n","Successfully installed Spire.Doc-12.7.1 plum-dispatch-1.7.4\n"]}]},{"cell_type":"code","source":["from spire.doc import *\n","from spire.doc.common import *\n","\n","# Documentクラスのオブジェクトを作成する\n","document = Document()\n","\n","# Word文書を読み込む\n","document.LoadFromFile(\"/content/drive/MyDrive/Classroom/[EB202] マクロ経済分析 2024/24homework02_C3EB1144_鈴木由楽.docx\")\n","\n","# 文書をPDFファイルとして保存する\n","document.SaveToFile(\"出力/PDF1.pdf\", FileFormat.PDF)\n","document.Close()"],"metadata":{"id":"rwFYnvXt6Eg1","executionInfo":{"status":"ok","timestamp":1730350291691,"user_tz":-540,"elapsed":1290,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}}},"execution_count":38,"outputs":[]},{"cell_type":"code","source":["from pypdf import PdfReader #1.read_pdf\n","\n","\n","def read_text_from_pdf(pdf_path):\n","    reader = PdfReader(pdf_path)\n","    text = \"\"\n","    for page_num in range(len(reader.pages)):\n","        page = reader.pages[page_num]\n","        text += page.extract_text()\n","    return text\n","\n","\n","# PDFファイルのパスを指定してテキストを取得\n","pdf_text = read_text_from_pdf(\"/content/drive/MyDrive/プログラミング（AI活用）/出力/PDF1.pdf\")"],"metadata":{"id":"ZasKNeT7PmMw","executionInfo":{"status":"ok","timestamp":1730350868982,"user_tz":-540,"elapsed":502,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}}},"execution_count":40,"outputs":[]},{"cell_type":"markdown","source":["[Faissとは](https://note.com/masuidrive/n/n5dc6da6dd2b6)"],"metadata":{"id":"W2OSp9YL9m_7"}},{"cell_type":"code","source":["#Faissを用いてテキスト分割、データベース作成\n","!pip install faiss-gpu\n","from langchain_community.vectorstores import FAISS\n","from langchain_community.embeddings import HuggingFaceEmbeddings\n","from langchain.text_splitter import RecursiveCharacterTextSplitter\n","\n","# チャンク間でoverlappingさせながらテキストを分割\n","text_splitter = RecursiveCharacterTextSplitter(\n","    chunk_size=200,\n","    chunk_overlap=50,\n",")\n","# テキストを分割\n","splited_text = text_splitter.split_text(pdf_text)\n","\n","embeddings = HuggingFaceEmbeddings(\n","    model_name=\"oshizo/sbert-jsnli-luke-japanese-base-lite\"\n",")\n","\n","# テキストを埋め込みベクトルに変換\n","index = FAISS.from_texts(splited_text, embedding=embeddings)\n","# FaissのRetrieverを取得\n","retriever = index.as_retriever(search_kwargs={\"k\": 4})"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"9jeth8_cPwwm","executionInfo":{"status":"ok","timestamp":1730350968750,"user_tz":-540,"elapsed":8288,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"8964cc3b-6a3c-433b-dc97-20d60301d756"},"execution_count":41,"outputs":[{"output_type":"stream","name":"stdout","text":["Requirement already satisfied: faiss-gpu in /usr/local/lib/python3.10/dist-packages (1.7.2)\n"]}]},{"cell_type":"code","source":["import os\n","from langchain_core.prompts import ChatPromptTemplate\n","from langchain.chains import create_retrieval_chain\n","from langchain.chains.combine_documents import create_stuff_documents_chain\n","from langchain.memory import ConversationBufferMemory\n","from langchain.chat_models import ChatOpenAI\n","from langchain.prompts.chat import (\n","    ChatPromptTemplate,\n","    SystemMessagePromptTemplate,\n","    HumanMessagePromptTemplate,\n",")\n","from langchain.chains import ConversationChain\n","from langchain.document_loaders import TextLoader\n","from langchain.embeddings.openai import OpenAIEmbeddings\n","\n","#input\n","\n","user_input = input(\"質問を入力してください: \")\n","\n","#process\n","# 言語モデルのラッパーを初期化\n","chat = ChatOpenAI(temperature=0, model_name=\"gpt-3.5-turbo\")\n","\n","# メモリオブジェクトを作成\n","memory = ConversationBufferMemory(return_messages=True,input_key=\"input\")\n","\n","# システムプロンプトを設定\n","system_prompt = (\n","    \"あなたは優秀なアシスタントです。\"\n","    \"資料を参照の上、必ず日本語で回答してください。\"\n","    \"英語で回答してはいけません。\"\n","    \"\\n\\n\"\n","    \"{context}\"\n",")\n","\n","# チャットプロンプトを設定\n","prompt = ChatPromptTemplate.from_messages(\n","    [\n","        (\"system\", system_prompt),\n","        (\"human\", \"{input}\"),\n","    ]\n",")\n","\n","# Chain Creation\n","# 会話チェーンとRAGを組み合わせたチェーンを作成\n","conversation = create_stuff_documents_chain(chat,prompt)\n","rag_chain = create_retrieval_chain(retriever, conversation)\n","\n","response = rag_chain.invoke({\"input\":user_input})\n","\n","#output\n","print(user_input)\n","print(response[\"answer\"])"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"7UqxsnkR3kph","executionInfo":{"status":"ok","timestamp":1730351313382,"user_tz":-540,"elapsed":12469,"user":{"displayName":"鈴木由楽","userId":"12702162578142968440"}},"outputId":"d9968bf1-f032-4748-a2f6-d255194ff547"},"execution_count":43,"outputs":[{"output_type":"stream","name":"stdout","text":["質問を入力してください: ケインジアンとは何ですか\n","ケインジアンとは何ですか\n","ケインジアンとは、イギリスの経済学者であるジョン・メイナード・ケインズの名前に由来する経済学の理論や政策のことを指します。ケインズは、大恐慌時代における景気循環の説明や対策として、政府が積極的に経済に介入する必要性を主張しました。ケインズ主義は、需要管理政策や財政政策、特に公共支出の拡大や税制の調整を通じて景気を est することを重視します。また、ケインズは、市場経済が自己調整力を持たず、不況や失業が発生する可能性があるという考え方を提唱しました。\n"]}]}],"metadata":{"colab":{"provenance":[],"gpuType":"T4","authorship_tag":"ABX9TyPqjhYRCoo3a0eeCquJHLRI"},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"},"accelerator":"GPU"},"nbformat":4,"nbformat_minor":0}